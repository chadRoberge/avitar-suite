{{! Onboarding Message (if needed) }}
{{#if this.needsOnboarding}}
  <div class="avitar-card avitar-bg-warning-light avitar-border-warning avitar-mb-6">
    <div class="avitar-card__body avitar-p-4">
      <div class="avitar-flex avitar-items-start avitar-gap-4">
        <div class="avitar-flex-shrink-0">
          {{{lnr-icon "warning" class="avitar-text-2xl avitar-text-warning"}}}
        </div>
        <div class="avitar-flex-1">
          <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">Complete Your Profile</h3>
          <p class="avitar-mb-3">Please complete your profile before managing subscriptions.</p>
          <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.goToOnboarding}}>
            Complete Profile
          </button>
        </div>
      </div>
    </div>
  </div>
{{else}}
  {{! Current Plan Card }}
  <div class="avitar-card avitar-mb-6">
    <div class="avitar-card__header">
      <h2 class="avitar-card__title">
        {{{lnr-icon "star" class="avitar-mr-2"}}}
        Current Plan
      </h2>
    </div>
    <div class="avitar-card__body">
      <div class="avitar-flex avitar-justify-between avitar-items-start">
        <div class="avitar-flex-1">
          <div class="avitar-flex avitar-items-center avitar-gap-3 avitar-mb-4">
            <h3 class="avitar-text-2xl avitar-font-bold">{{this.currentPlan.name}}</h3>
            {{#if this.isFreePlan}}
              <span class="avitar-badge avitar-badge--info">Free Plan</span>
            {{/if}}
            {{#if this.isCanceling}}
              <span class="avitar-badge avitar-badge--warning">Canceling</span>
            {{/if}}
          </div>

          <p class="avitar-text-muted avitar-mb-4">{{this.currentPlan.description}}</p>

          {{#if this.isFreePlan}}
            {{! Free plan - show friendly message }}
            <div class="avitar-mb-4">
              <div class="avitar-text-3xl avitar-font-bold avitar-text-success">
                Free
              </div>
              <p class="avitar-text-sm avitar-text-muted avitar-mt-1">
                No credit card required
              </p>
            </div>

            {{! Free plan info box }}
            <div class="avitar-bg-info-light avitar-p-4 avitar-rounded avitar-mb-4">
              <div class="avitar-flex avitar-items-start avitar-gap-3">
                {{{lnr-icon "gift" class="avitar-text-primary avitar-text-lg avitar-mt-1"}}}
                <div>
                  <p class="avitar-text-sm avitar-font-medium avitar-mb-1">You're on the Free Plan</p>
                  <p class="avitar-text-sm avitar-text-muted">
                    Enjoy basic access to submit and track building permits. Upgrade anytime to unlock more features.
                  </p>
                </div>
              </div>
            </div>
          {{else}}
            {{! Paid plan pricing }}
            <div class="avitar-mb-4">
              <div class="avitar-text-3xl avitar-font-bold avitar-text-primary">
                ${{this.currentPlan.pricing.amount}}
                <span class="avitar-text-base avitar-text-muted avitar-font-normal">
                  /{{this.currentPlan.pricing.interval}}
                </span>
              </div>
            </div>

            {{#if this.nextBillingDate}}
              <div class="avitar-mb-2">
                <span class="avitar-text-sm avitar-text-muted">Next billing date:</span>
                <span class="avitar-text-sm avitar-font-medium">
                  {{date-format this.nextBillingDate "MMMM DD, YYYY"}}
                </span>
              </div>
            {{/if}}

            {{#if this.upcomingInvoiceAmount}}
              <div class="avitar-mb-4">
                <span class="avitar-text-sm avitar-text-muted">Upcoming charge:</span>
                <span class="avitar-text-sm avitar-font-medium">${{this.upcomingInvoiceAmount}}</span>
              </div>
            {{/if}}
          {{/if}}
        </div>

        <div class="avitar-flex avitar-flex-col avitar-gap-2">
          {{#unless this.isFreePlan}}
            {{#if this.isCanceling}}
              <button
                type="button"
                class="avitar-btn avitar-btn--success"
                {{on "click" this.reactivateSubscription}}
                disabled={{this.isLoading}}
              >
                {{{lnr-icon "redo" class="avitar-mr-2"}}}
                Reactivate
              </button>
            {{else}}
              <button
                type="button"
                class="avitar-btn avitar-btn--danger"
                {{on "click" this.openCancelModal}}
                disabled={{this.isLoading}}
              >
                {{{lnr-icon "cross" class="avitar-mr-2"}}}
                Cancel Plan
              </button>
            {{/if}}

            <button
              type="button"
              class="avitar-btn avitar-btn--secondary"
              {{on "click" this.openPaymentMethods}}
            >
              {{{lnr-icon "credit-card" class="avitar-mr-2"}}}
              Payment Methods
            </button>
          {{/unless}}

          {{#unless this.isFreePlan}}
            <button
              type="button"
              class="avitar-btn avitar-btn--secondary"
              {{on "click" this.viewBillingHistory}}
            >
              {{{lnr-icon "license" class="avitar-mr-2"}}}
              Billing History
            </button>
          {{/unless}}
        </div>
      </div>

      {{! Current Plan Features }}
      <div class="avitar-text-left avitar-space-y-3">
        <div class="avitar-text-sm avitar-font-semibold avitar-mb-2">Your Plan Features:</div>
        {{#each this.currentPlan.features as |feature|}}
          <div class="avitar-flex avitar-items-start avitar-gap-2">
            {{{lnr-icon "checkmark-circle" class="avitar-text-success avitar-mt-1"}}}
            <span class="avitar-text-sm">{{feature}}</span>
          </div>
        {{/each}}
      </div>
    </div>
  </div>

  {{! Available Plans }}
  {{#if this.availablePlans.length}}
    <div class="avitar-mb-6">
      <h2 class="avitar-text-2xl avitar-font-bold avitar-mb-4">
        {{#if this.isFreePlan}}
          Choose Your Plan
        {{else}}
          Upgrade Your Plan
        {{/if}}
      </h2>

      <div class="avitar-grid avitar-grid-cols-3 avitar-gap-6">
        {{#each this.displayPlans as |plan|}}
          {{#unless plan.isCurrent}}
            <div class="avitar-card">
              <div class="avitar-card__body avitar-text-center">
                <h3 class="avitar-text-2xl avitar-font-bold avitar-mb-2">{{plan.name}}</h3>
                <p class="avitar-text-sm avitar-text-muted avitar-mb-4">{{plan.description}}</p>

                <div class="avitar-mb-6">
                  <div class="avitar-text-4xl avitar-font-bold avitar-text-primary">
                    {{plan.pricingText}}
                  </div>
                </div>

                <button
                  type="button"
                  class="avitar-btn avitar-btn--primary avitar-w-full avitar-mb-6"
                  {{on "click" (fn this.openUpgradeModal plan)}}
                  disabled={{this.isLoading}}
                >
                  {{#if this.isFreePlan}}
                    Get Started
                  {{else}}
                    Upgrade Now
                  {{/if}}
                </button>

                <div class="avitar-text-left avitar-space-y-3">
                  <div class="avitar-text-sm avitar-font-semibold avitar-mb-2">Features:</div>

                  {{#each plan.featureList as |feature|}}
                    <div class="avitar-flex avitar-items-start avitar-gap-2">
                      {{{lnr-icon "checkmark-circle" class="avitar-text-success avitar-mt-1"}}}
                      <span class="avitar-text-sm">{{feature}}</span>
                    </div>
                  {{/each}}
                </div>
              </div>
            </div>
          {{/unless}}
        {{/each}}
      </div>
    </div>
  {{/if}}
{{/if}}

{{! Upgrade Confirmation Modal }}
{{#if this.showUpgradeModal}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.cancelUpgrade}}>
    <div class="avitar-modal" {{on "click" this.stopPropagation}} role="dialog" aria-modal="true">
      <div class="avitar-modal__header">
        <h2 class="avitar-modal__title">
          {{{lnr-icon "arrow-up" class="avitar-mr-2"}}}
          Confirm Upgrade
        </h2>
        <button type="button" class="avitar-modal__close" {{on "click" this.cancelUpgrade}}>
          {{{lnr-icon "cross"}}}
        </button>
      </div>

      <div class="avitar-modal__body">
        <div class="avitar-bg-primary-light avitar-p-4 avitar-rounded avitar-mb-4">
          <div class="avitar-text-center">
            <div class="avitar-text-sm avitar-text-muted avitar-mb-1">Upgrading to</div>
            <div class="avitar-text-2xl avitar-font-bold">{{this.selectedPlan.name}}</div>
            <div class="avitar-text-3xl avitar-font-bold avitar-text-primary avitar-mt-2">
              {{this.selectedPlan.pricingText}}
            </div>
          </div>
        </div>

        {{#unless this.isFreePlan}}
          <div class="avitar-mb-4">
            <p class="avitar-text-sm avitar-text-muted">
              Your new plan will take effect immediately. You will be charged a prorated amount for the remainder of your current billing period.
            </p>
          </div>
        {{/unless}}

        <div class="avitar-space-y-2">
          <h4 class="avitar-font-semibold">Plan Features:</h4>
          <div class="avitar-space-y-2">
            {{#if this.selectedPlan.featureList.length}}
              {{#each this.selectedPlan.featureList as |feature|}}
                <div class="avitar-flex avitar-items-start avitar-gap-2">
                  {{{lnr-icon "checkmark-circle" class="avitar-text-success avitar-mt-1"}}}
                  <span class="avitar-text-sm">{{feature}}</span>
                </div>
              {{/each}}
            {{else}}
              <p class="avitar-text-sm avitar-text-muted">No additional features listed.</p>
            {{/if}}
          </div>
        </div>
      </div>

      <div class="avitar-modal__footer">
        <button
          type="button"
          class="avitar-btn avitar-btn--secondary"
          {{on "click" this.cancelUpgrade}}
          disabled={{this.isLoading}}
        >
          Cancel
        </button>
        <button
          type="button"
          class="avitar-btn avitar-btn--primary"
          {{on "click" this.confirmUpgrade}}
          disabled={{this.isLoading}}
        >
          {{#if this.isLoading}}
            {{{lnr-icon "sync" class="avitar-mr-2 avitar-spin"}}}
            Processing...
          {{else}}
            {{{lnr-icon "checkmark-circle" class="avitar-mr-2"}}}
            Confirm Upgrade
          {{/if}}
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{! Cancel Subscription Modal }}
{{#if this.showCancelModal}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.closeCancelModal}}>
    <div class="avitar-modal" {{on "click" this.stopPropagation}} role="dialog" aria-modal="true">
      <div class="avitar-modal__header">
        <h2 class="avitar-modal__title">
          {{{lnr-icon "warning" class="avitar-mr-2 avitar-text-warning"}}}
          Cancel Subscription
        </h2>
        <button type="button" class="avitar-modal__close" {{on "click" this.closeCancelModal}}>
          {{{lnr-icon "cross"}}}
        </button>
      </div>

      <div class="avitar-modal__body">
        <p class="avitar-mb-4">
          Are you sure you want to cancel your subscription? You will lose access to premium features.
        </p>

        <div class="avitar-bg-gray-50 avitar-p-4 avitar-rounded avitar-mb-4">
          <label class="avitar-flex avitar-items-start avitar-gap-3">
            <input
              type="checkbox"
              class="avitar-checkbox avitar-mt-1"
              checked={{this.cancelImmediately}}
              {{on "change" this.toggleCancelImmediately}}
            />
            <div>
              <div class="avitar-font-medium">Cancel Immediately</div>
              <div class="avitar-text-sm avitar-text-muted">
                Check this to cancel now. Otherwise, you'll retain access until the end of your billing period.
              </div>
            </div>
          </label>
        </div>

        {{#unless this.cancelImmediately}}
          <div class="avitar-bg-info-light avitar-p-3 avitar-rounded">
            <div class="avitar-text-sm">
              {{{lnr-icon "information" class="avitar-mr-2"}}}
              Your subscription will remain active until {{date-format this.nextBillingDate "MMMM DD, YYYY"}}.
            </div>
          </div>
        {{/unless}}
      </div>

      <div class="avitar-modal__footer">
        <button
          type="button"
          class="avitar-btn avitar-btn--secondary"
          {{on "click" this.closeCancelModal}}
          disabled={{this.isLoading}}
        >
          Keep Subscription
        </button>
        <button
          type="button"
          class="avitar-btn avitar-btn--danger"
          {{on "click" this.cancelSubscription}}
          disabled={{this.isLoading}}
        >
          {{#if this.isLoading}}
            {{{lnr-icon "sync" class="avitar-mr-2 avitar-spin"}}}
            Processing...
          {{else}}
            {{{lnr-icon "cross" class="avitar-mr-2"}}}
            Confirm Cancellation
          {{/if}}
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{! Billing History Modal }}
{{#if this.showBillingHistoryModal}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.closeBillingHistoryModal}}>
    <div class="avitar-modal avitar-modal--lg" {{on "click" this.stopPropagation}} role="dialog" aria-modal="true">
      <div class="avitar-modal__header">
        <h2 class="avitar-modal__title">
          {{{lnr-icon "license" class="avitar-mr-2"}}}
          Billing History
        </h2>
        <button type="button" class="avitar-modal__close" {{on "click" this.closeBillingHistoryModal}}>
          {{{lnr-icon "cross"}}}
        </button>
      </div>

      <div class="avitar-modal__body">
        {{#if this.isLoadingInvoices}}
          <div class="avitar-text-center avitar-py-8">
            {{{lnr-icon "sync" class="avitar-text-3xl avitar-text-primary avitar-mb-4 avitar-spin"}}}
            <p class="avitar-text-muted">Loading billing history...</p>
          </div>
        {{else}}
          {{#if this.billingInvoices.length}}
            <div class="avitar-table-container">
              <table class="avitar-table">
                <thead>
                  <tr>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Period</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {{#each this.billingInvoices as |invoice|}}
                    <tr>
                      <td>
                        <div class="avitar-font-medium">{{invoice.number}}</div>
                      </td>
                      <td>
                        <div class="avitar-text-sm">
                          {{date-format (multiply invoice.created 1000) "MMM DD, YYYY"}}
                        </div>
                      </td>
                      <td>
                        <div class="avitar-text-sm avitar-text-muted">
                          {{date-format (multiply invoice.period_start 1000) "MMM DD"}} - {{date-format (multiply invoice.period_end 1000) "MMM DD, YYYY"}}
                        </div>
                      </td>
                      <td>
                        <div class="avitar-font-medium">
                          ${{invoice.amount_paid}}
                        </div>
                      </td>
                      <td>
                        {{#if (eq invoice.status "paid")}}
                          <span class="avitar-badge avitar-badge--success">Paid</span>
                        {{else if (eq invoice.status "open")}}
                          <span class="avitar-badge avitar-badge--warning">Open</span>
                        {{else if (eq invoice.status "void")}}
                          <span class="avitar-badge avitar-badge--secondary">Void</span>
                        {{else if (eq invoice.status "uncollectible")}}
                          <span class="avitar-badge avitar-badge--danger">Uncollectible</span>
                        {{else}}
                          <span class="avitar-badge">{{invoice.status}}</span>
                        {{/if}}
                      </td>
                      <td>
                        <div class="avitar-flex avitar-gap-2">
                          {{#if invoice.invoice_pdf}}
                            <button
                              type="button"
                              class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                              {{on "click" (fn this.downloadInvoice invoice)}}
                              title="Download PDF"
                            >
                              {{{lnr-icon "download"}}}
                            </button>
                          {{/if}}
                          {{#if invoice.hosted_invoice_url}}
                            <button
                              type="button"
                              class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                              {{on "click" (fn this.viewInvoiceOnline invoice)}}
                              title="View Online"
                            >
                              {{{lnr-icon "link"}}}
                            </button>
                          {{/if}}
                        </div>
                      </td>
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            </div>
          {{else}}
            <div class="avitar-empty-state avitar-py-8">
              <div class="avitar-mb-4">
                {{{lnr-icon "license" class="avitar-text-3xl avitar-text-muted"}}}
              </div>
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">No Billing History</h3>
              <p class="avitar-text-muted">You don't have any invoices yet.</p>
            </div>
          {{/if}}
        {{/if}}
      </div>

      <div class="avitar-modal__footer">
        <button
          type="button"
          class="avitar-btn avitar-btn--secondary"
          {{on "click" this.closeBillingHistoryModal}}
        >
          Close
        </button>
      </div>
    </div>
  </div>
{{/if}}

{{! Stripe Payment Modal }}
<StripePaymentModal
  @isOpen={{this.showPaymentModal}}
  @title={{this.paymentTitle}}
  @description={{this.paymentDescription}}
  @amount={{this.paymentAmount}}
  @currency="USD"
  @billingEmail={{this.billingEmail}}
  @billingName={{this.billingName}}
  @onClose={{this.closePaymentModal}}
  @onPaymentMethodReady={{this.handlePaymentMethodReady}}
/>

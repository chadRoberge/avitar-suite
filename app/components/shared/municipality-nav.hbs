{{!-- Municipality Navigation Component using Avitar Topbar Design --}}
<div class="municipal-navigation {{if this.hasActiveChildren 'has-children'}}" style={{this.navStyles}}>

  {{!-- Primary Top Bar with Brand and Modules --}}
  <nav class="avitar-topbar">
    {{!-- Municipal Brand with Selector --}}
    <Navigation::MunicipalitySelector />

    {{!-- Mobile Module Dropdown (visible only on mobile) --}}
    <Navigation::MobileModuleDropdown />

    {{!-- Desktop Module Navigation (hidden on mobile via CSS) --}}
    {{#if this.navigationItems.length}}
      <ul class="avitar-topbar__nav hide-mobile">
        {{#each this.navigationItems as |navItem|}}
          <li class="avitar-topbar__nav-item">
            <a
              href="#"
              class="avitar-topbar__nav-link {{if (this.isModuleActive navItem) 'avitar-topbar__nav-link--active'}}"
              {{on "click" (fn this.navigateToModule navItem)}}
            >
              {{lnr-icon navItem.icon}}
              {{navItem.title}}
              {{#if navItem.tier}}
                <span class="avitar-badge avitar-badge--{{navItem.tier}}">
                  {{navItem.tier}}
                </span>
              {{/if}}
            </a>
          </li>
        {{/each}}
      </ul>
    {{else}}
      <div class="avitar-empty-state hide-mobile">
        {{lnr-icon "layers"}}
        <span>No modules available</span>
      </div>
    {{/if}}

    {{!-- User Actions --}}
    <div class="avitar-topbar__user">
      {{!-- User Role Badge (desktop only) --}}
      {{#if this.userRole}}
        <span class="avitar-badge {{this.userRole.badge}} hide-mobile" title="Your role in this municipality">
          {{{lnr-icon "user"}}}
          <span class="avitar-ml-1">{{this.userRole.role}}</span>
        </span>
      {{/if}}

      {{!-- Department Badge (desktop only) --}}
      {{#if this.userDepartment}}
        <span class="avitar-badge avitar-badge--secondary avitar-ml-2 hide-mobile" title="Your department">
          {{{lnr-icon "briefcase"}}}
          <span class="avitar-ml-1">{{this.userDepartment}}</span>
        </span>
      {{/if}}

      {{!-- Subscription Info (desktop only) --}}
      {{#if this.municipality.subscriptionInfo}}
        <span class="avitar-badge avitar-badge--{{this.municipality.subscriptionInfo.tier}} avitar-ml-2 hide-mobile">
          {{this.municipality.subscriptionInfo.tier}} Plan
        </span>
      {{/if}}

      {{!-- User Name and Logout Button --}}
      {{#if this.userName}}
        <span class="avitar-text-sm avitar-ml-2 hide-mobile" style="color: white;">
          {{this.userName}}
        </span>
      {{/if}}
      <button
        class="avitar-btn avitar-btn--danger avitar-btn--sm avitar-ml-2"
        {{on "click" this.logout}}
        type="button"
        title="Logout {{if this.userName this.userName}}"
      >
        {{lnr-icon "exit" class="avitar-mr-1"}}
        Logout
      </button>
    </div>
  </nav>

  {{!-- Secondary Navigation for Active Module Children --}}
  {{#if this.hasActiveChildren}}
    <nav class="avitar-topbar module-children-nav">
      <ul class="avitar-topbar__nav">
        {{#each this.activeModuleChildren as |child index|}}
          <li class="avitar-topbar__nav-item {{if child.dropdown 'avitar-topbar__nav-item--dropdown'}}">
            {{#if child.component}}
              {{!-- Render component directly instead of link --}}
              {{component child.component property=this.selectedProperty selectedYear=this.assessmentYear municipalityId=this.currentMunicipalityId onYearChange=this.onAssessmentYearChange onAddToQueue=this.addSelectedToQueue onOpenPrint=this.openPrintModal}}
            {{else if child.dropdown}}
              {{!-- Dropdown navigation item --}}
              <button
                type="button"
                class="avitar-topbar__nav-link avitar-topbar__nav-link--dropdown"
                {{on "click" (fn this.toggleDropdown index)}}
              >
                <i class="fas fa-{{child.icon}}"></i>
                {{child.title}}
                <i class="fas fa-chevron-{{if (this.isDropdownOpen index) 'up' 'down'}} avitar-ml-2"></i>
              </button>

              {{#if (this.isDropdownOpen index)}}
                <div class="avitar-topbar__dropdown" {{on "click" this.stopPropagation}}>
                  {{#each child.items as |item|}}
                    <LinkTo
                      @route={{item.route}}
                      class="avitar-topbar__dropdown-link"
                    >
                      <i class="fas fa-{{item.icon}} avitar-mr-2"></i>
                      {{item.title}}
                    </LinkTo>
                  {{/each}}
                </div>
              {{/if}}
            {{else if child.models}}
              <LinkTo
                @route={{child.route}}
                @models={{child.models}}
                @query={{this.currentQueryParams}}
                class="avitar-topbar__nav-link"
                @activeClass="avitar-topbar__nav-link--active"
              >
                <i class="fas fa-{{child.icon}}"></i>
                {{child.title}}
                {{#if child.badge}}
                  <span class="avitar-badge {{if child.badgeClass child.badgeClass 'avitar-badge--warning'}}">
                    {{child.badge}}
                  </span>
                {{/if}}
              </LinkTo>
            {{else}}
              <LinkTo
                @route={{child.route}}
                @query={{this.currentQueryParams}}
                class="avitar-topbar__nav-link {{if child.iconOnly 'avitar-topbar__nav-link--icon-only'}}"
                @activeClass="avitar-topbar__nav-link--active"
                title={{if child.iconOnly child.title}}
              >
                {{#if child.iconOnly}}
                  {{{lnr-icon child.icon}}}
                {{else}}
                  <i class="fas fa-{{child.icon}}"></i>
                  {{child.title}}
                {{/if}}
                {{#if child.badge}}
                  <span class="avitar-badge {{if child.badgeClass child.badgeClass 'avitar-badge--warning'}}">
                    {{child.badge}}
                  </span>
                {{/if}}
              </LinkTo>
            {{/if}}
          </li>
        {{/each}}
      </ul>
    </nav>
  {{/if}}

  {{!-- Property Record Card Print Modal --}}
  <Assessing::PropertyRecordCardModal
    @isOpen={{this.isPrintModalOpen}}
    @onClose={{this.closePrintModal}}
  />

  {{!-- Mobile Bottom Tab Bar --}}
  <Navigation::BottomTabBar
    @showPIDButton={{this.showPIDButton}}
    @onOpenPIDSheet={{this.openPIDSheet}}
  />

  {{!-- PID Bottom Sheet (for Assessing/Tax modules on mobile) --}}
  <Navigation::PidBottomSheet
    @isOpen={{this.isPIDSheetOpen}}
    @onClose={{this.closePIDSheet}}
  />

</div>
{{!-- Sketch Edit Modal --}}
{{#if @isOpen}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.handleOverlayClick}}>
    <div class="avitar-modal avitar-modal--xl" style="width: 95vw; max-width: 1400px;" {{on "click" this.preventClose}}>
      <div class="avitar-modal__header">
        <div class="avitar-flex avitar-items-center avitar-gap-4 avitar-flex-grow">
          {{!-- Drawing Tools in Header --}}
          <div class="avitar-flex avitar-gap-2">
            <button 
              type="button"
              class="avitar-btn avitar-btn--sm {{if (eq this.drawingMode 'rectangle') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
              {{on "click" (fn this.setDrawingMode "rectangle")}}
            >
              <i class="fas fa-square"></i>
              Rectangle
            </button>
            <button 
              type="button"
              class="avitar-btn avitar-btn--sm {{if (eq this.drawingMode 'circle') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
              {{on "click" (fn this.setDrawingMode "circle")}}
            >
              <i class="fas fa-circle"></i>
              Circle
            </button>
            <button
              type="button"
              class="avitar-btn avitar-btn--sm {{if (eq this.drawingMode 'polygon') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
              {{on "click" (fn this.setDrawingMode "polygon")}}
            >
              <i class="fas fa-draw-polygon"></i>
              Polygon
            </button>
            <button
              type="button"
              class="avitar-btn avitar-btn--sm {{if (eq this.drawingMode 'arc-segment') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
              {{on "click" (fn this.setDrawingMode "arc-segment")}}
            >
              <i class="fas fa-bezier-curve"></i>
              Arc Segment
            </button>

            {{!-- Clear Selection Button --}}
            {{#if this.selectedShape}}
              <div class="avitar-border-l avitar-pl-2">
                <button 
                  type="button"
                  class="avitar-btn avitar-btn--secondary avitar-btn--sm"
                  {{on "click" this.clearSelection}}
                >
                  <i class="fas fa-times-circle"></i>
                  Clear Selection
                </button>
              </div>
            {{/if}}
            
            {{!-- Shape Completion Controls --}}
            {{#if this.drawingMode}}
              <div class="avitar-border-l avitar-pl-2 avitar-flex avitar-gap-2">
                {{#if (eq this.drawingMode "polygon")}}
                  <div class="avitar-text-sm avitar-text-muted avitar-px-2 avitar-flex avitar-items-center">
                    <i class="fas fa-info-circle avitar-mr-1"></i>
                    Left click: add vertex | Right click: complete
                  </div>
                {{else if (eq this.drawingMode "arc-segment")}}
                  <div class="avitar-text-sm avitar-text-muted avitar-px-2 avitar-flex avitar-items-center">
                    <i class="fas fa-info-circle avitar-mr-1"></i>
                    Click 1: arc start | Click 2: arc end | Click 3: set radius
                  </div>
                {{/if}}
                <button 
                  type="button"
                  class="avitar-btn avitar-btn--warning avitar-btn--sm"
                  {{on "click" this.cancelDrawing}}
                >
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button 
                  type="button"
                  class="avitar-btn avitar-btn--secondary avitar-btn--sm"
                  {{on "click" this.startNewShape}}
                >
                  <i class="fas fa-plus"></i>
                  New Shape
                </button>
              </div>
            {{/if}}
          </div>

          {{!-- Status indicator --}}
          {{#if @isDirty}}
            <span class="avitar-text-warning">
              <i class="fas fa-circle avitar-text-xs"></i>
              Unsaved changes
            </span>
          {{/if}}
        </div>

        <button 
          type="button" 
          class="avitar-modal__close"
          {{on "click" @onClose}}
        >
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="avitar-modal__body">
        <form {{on "submit" this.handleSave}}>

          {{!-- Canvas and Right Panel Layout --}}
          <div class="avitar-flex avitar-gap-4">
            {{!-- Canvas (Left Side) --}}
            <div class="avitar-flex-4">
              <div class="avitar-border avitar-rounded" style="height: 60vh; overflow: hidden;">
                <Assessing::SketchCanvas 
                  @shapes={{this.shapesForCanvas}}
                  @sketch={{this.editedSketch}}
                  @drawingMode={{this.drawingMode}}
                  @selectedShape={{this.selectedShape}}
                  @onShapeAdd={{this.addShape}}
                  @onShapeSelect={{this.selectShape}}
                  @onFinishPolygon={{this.finishPolygon}}
                  @onForceUpdate={{this.handleCanvasUpdate}}
                  @onCanvasReady={{this.handleCanvasReady}}
                  @width={{800}}
                  @height={{500}}
                />
              </div>
            </div>

            {{!-- Right Panel --}}
            <div class="avitar-flex-6">
              <div class="avitar-border avitar-rounded" style="height: 60vh; overflow-y: auto;">
                {{#if this.drawingMode}}
                  <div class="avitar-p-4">
                    {{!-- Drawing Mode: Show Description Selection --}}
                    <h5 class="avitar-font-semibold avitar-mb-3">
                      <i class="fas fa-tags avitar-mr-2"></i>
                      Shape Attributes
                    </h5>
                    <div class="avitar-text-sm avitar-text-muted avitar-mb-3">
                      Click attributes to add them to new shapes (order matters):
                    </div>
                    
                    {{!-- Available Description Buttons --}}
                    <div class="avitar-grid avitar-grid-cols-2 avitar-gap-2 avitar-mb-4">
                      {{#if this.factorsLoaded}}
                        {{#each this.availableDescriptions as |desc|}}
                          <button 
                            type="button"
                            class="avitar-btn avitar-btn--secondary avitar-btn--sm avitar-text-xs avitar-p-2"
                            {{on "click" (fn this.addPreSelectedAttribute desc.code)}}
                          >
                            <div class="avitar-font-semibold">{{desc.code}}</div>
                            <div class="avitar-text-xs avitar-text-muted">{{desc.points}}%</div>
                          </button>
                        {{else}}
                          <div class="avitar-text-center avitar-text-muted avitar-py-4 avitar-col-span-2">
                            No sub-area factors available. Please add some in the municipality settings.
                          </div>
                        {{/each}}
                      {{else}}
                        <div class="avitar-text-center avitar-text-muted avitar-py-4 avitar-col-span-2">
                          <i class="fas fa-spinner fa-spin avitar-mr-2"></i>
                          Loading sub-area factors...
                        </div>
                      {{/if}}
                    </div>
                    
                    {{!-- Selected Attributes List --}}
                    {{#if this.preSelectedAttributes.length}}
                      <div class="avitar-bg-success-light avitar-p-3 avitar-rounded">
                        <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-2">
                          <strong class="avitar-text-sm">Selected (Top to Bottom):</strong>
                          <button 
                            type="button" 
                            class="avitar-btn avitar-btn--danger avitar-btn--xs"
                            {{on "click" this.clearPreSelectedAttributes}}
                          >
                            Clear
                          </button>
                        </div>
                        <div class="avitar-space-y-1">
                          {{#each this.preSelectedAttributes as |code index|}}
                            <div class="avitar-flex avitar-items-center avitar-justify-between avitar-p-2 avitar-bg-white avitar-border avitar-rounded avitar-text-sm">
                              <span>
                                <span class="avitar-font-semibold">{{code}}</span>
                                <span class="avitar-text-xs avitar-text-muted avitar-ml-1">
                                  ({{this.getDescriptionRate code}}x)
                                </span>
                              </span>
                              <button 
                                type="button"
                                class="avitar-btn avitar-btn--danger avitar-btn--xs"
                                {{on "click" (fn this.removePreSelectedAttribute index)}}
                              >
                                <i class="fas fa-times"></i>
                              </button>
                            </div>
                          {{/each}}
                        </div>
                        <div class="avitar-mt-2 avitar-text-sm">
                          <strong>Total Multiplier:</strong> {{this.preSelectedEffectiveRate}}x
                        </div>
                      </div>
                    {{/if}}
                  </div>
                {{else if this.selectedShape}}
                  {{!-- Selected Shape Mode: Show Shape Properties --}}
                  {{!-- Sticky Shape Info Section --}}
                  <div class="avitar-sticky avitar-top-0 avitar-bg-white avitar-z-10 avitar-pb-4 avitar-border-b avitar-mb-4" style="position: sticky; top: 0; z-index: 10;">
                    {{!-- Shape Info --}}
                    <div class="avitar-bg-gray-50 avitar-p-3 avitar-rounded avitar-mb-3">
                      <div class="avitar-flex avitar-justify-end avitar-mb-2">
                        <button 
                          type="button"
                          class="avitar-btn avitar-btn--danger avitar-btn--sm"
                          {{on "click" (fn this.deleteShape this.selectedShape._id)}}
                        >
                          <i class="fas fa-trash avitar-mr-1"></i>
                          Delete
                        </button>
                      </div>
                      <div class="avitar-text-sm avitar-mb-2">
                        <div><strong>Total Area:</strong> {{number-format this.selectedShape.area}} sq ft</div>
                        <div><strong>Total Effective:</strong> {{number-format this.selectedShape.total_effective_area}} sq ft</div>
                      </div>
                      
                      {{!-- Compact Description Breakdown --}}
                      {{#if (and this.selectedShape.descriptions this.selectedShape.descriptions.length)}}
                        <div class="avitar-border-t avitar-pt-2">
                          <div class="avitar-text-xs avitar-font-semibold avitar-mb-1 avitar-text-gray-600">Description Breakdown:</div>
                          {{#each this.selectedShape.descriptions as |desc index|}}
                            <div class="avitar-flex avitar-justify-between avitar-items-center avitar-text-xs avitar-py-1">
                              <span class="avitar-font-semibold">{{this.getDescriptionLabel desc}}</span>
                              <span>{{this.getDescriptionRate (this.getDescriptionLabel desc)}}x</span>
                              <span class="avitar-font-semibold avitar-text-green-600">
                                {{number-format (this.getDescriptionEffectiveArea desc)}} sq ft
                              </span>
                              <div class="avitar-flex avitar-gap-1 avitar-ml-2">
                                {{!-- Move Up Button --}}
                                <button 
                                  type="button"
                                  class="avitar-btn avitar-btn--secondary avitar-btn--xs {{if (eq index 0) 'avitar-opacity-50' ''}}"
                                  disabled={{eq index 0}}
                                  {{on "click" (fn this.moveShapeDescriptionUp this.selectedShape._id index)}}
                                >
                                  <i class="fas fa-chevron-up"></i>
                                </button>
                                {{!-- Move Down Button --}}
                                <button 
                                  type="button"
                                  class="avitar-btn avitar-btn--secondary avitar-btn--xs {{if (eq index (subtract this.selectedShape.descriptions.length 1)) 'avitar-opacity-50' ''}}"
                                  disabled={{eq index (subtract this.selectedShape.descriptions.length 1)}}
                                  {{on "click" (fn this.moveShapeDescriptionDown this.selectedShape._id index)}}
                                >
                                  <i class="fas fa-chevron-down"></i>
                                </button>
                                {{!-- Remove Button --}}
                                <button 
                                  type="button"
                                  class="avitar-btn avitar-btn--danger avitar-btn--xs"
                                  {{on "click" (fn this.removeShapeDescription this.selectedShape._id index)}}
                                >
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                            </div>
                          {{/each}}
                        </div>
                      {{/if}}
                    </div>
                  </div>

                  {{!-- Add Descriptions --}}
                  <div class="avitar-mb-4 avitar-p-4">
                    <div class="avitar-font-semibold avitar-mb-2">Add Descriptions:</div>
                    <div class="avitar-grid avitar-grid-cols-2 avitar-gap-2">
                      {{#if this.factorsLoaded}}
                        {{#each this.availableDescriptions as |desc|}}
                          <button 
                            type="button"
                            class="avitar-btn avitar-btn--secondary avitar-btn--xs avitar-p-2"
                            {{on "click" (fn this.addShapeDescription this.selectedShape._id desc.code)}}
                          >
                            <div class="avitar-font-semibold">{{desc.code}}</div>
                            <div class="avitar-text-xs avitar-text-muted">{{desc.points}}%</div>
                          </button>
                        {{else}}
                          <div class="avitar-text-center avitar-text-muted avitar-py-4 avitar-col-span-2">
                            No sub-area factors available. Please add some in the municipality settings.
                          </div>
                        {{/each}}
                      {{else}}
                        <div class="avitar-text-center avitar-text-muted avitar-py-4 avitar-col-span-2">
                          <i class="fas fa-spinner fa-spin avitar-mr-2"></i>
                          Loading sub-area factors...
                        </div>
                      {{/if}}
                    </div>
                  </div>

                {{else}}
                  {{!-- Default State --}}
                  <div class="avitar-text-center avitar-py-8 avitar-p-4">
                    <i class="fas fa-mouse-pointer avitar-text-4xl avitar-text-muted avitar-mb-3"></i>
                    <div class="avitar-text-muted">
                      <div class="avitar-font-semibold avitar-mb-1">Select a drawing tool</div>
                      <div class="avitar-text-sm">Or click a shape to edit it</div>
                    </div>
                  </div>
                {{/if}}
              </div>
            </div>
          </div>
        </form>

        {{!-- Tool Instructions Section --}}
        {{#if this.drawingMode}}
          <div class="avitar-border-t avitar-bg-gray-50 avitar-p-4 avitar-mt-4">
            <div class="avitar-text-sm">
              {{#if (eq this.drawingMode "rectangle")}}
                <div class="avitar-flex avitar-items-start avitar-gap-3">
                  <div class="avitar-flex-shrink-0 avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary avitar-text-white avitar-flex avitar-items-center avitar-justify-center">
                    <i class="fas fa-square"></i>
                  </div>
                  <div>
                    <div class="avitar-font-semibold avitar-mb-1">Rectangle Tool Instructions:</div>
                    <ol class="avitar-list-decimal avitar-ml-4 avitar-space-y-1">
                      <li><strong>First click:</strong> Click on the canvas to set one corner of the rectangle</li>
                      <li><strong>Move mouse:</strong> Watch the preview rectangle follow your cursor</li>
                      <li><strong>Second click:</strong> Click to set the opposite corner and create the rectangle</li>
                    </ol>
                    <div class="avitar-mt-2 avitar-text-muted">
                      <i class="fas fa-lightbulb avitar-mr-1"></i>
                      <strong>Tip:</strong> The rectangle will automatically snap to the grid (10 pixels = 1 foot)
                    </div>
                  </div>
                </div>
              {{else if (eq this.drawingMode "circle")}}
                <div class="avitar-flex avitar-items-start avitar-gap-3">
                  <div class="avitar-flex-shrink-0 avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary avitar-text-white avitar-flex avitar-items-center avitar-justify-center">
                    <i class="fas fa-circle"></i>
                  </div>
                  <div>
                    <div class="avitar-font-semibold avitar-mb-1">Circle Tool Instructions:</div>
                    <ol class="avitar-list-decimal avitar-ml-4 avitar-space-y-1">
                      <li><strong>First click:</strong> Click on the canvas to set the center point of the circle</li>
                      <li><strong>Move mouse:</strong> Watch the preview circle expand from the center</li>
                      <li><strong>Second click:</strong> Click to set the radius and create the circle</li>
                    </ol>
                    <div class="avitar-mt-2 avitar-text-muted">
                      <i class="fas fa-lightbulb avitar-mr-1"></i>
                      <strong>Tip:</strong> The radius will snap to grid increments for precise measurements
                    </div>
                  </div>
                </div>
              {{else if (eq this.drawingMode "polygon")}}
                <div class="avitar-flex avitar-items-start avitar-gap-3">
                  <div class="avitar-flex-shrink-0 avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary avitar-text-white avitar-flex avitar-items-center avitar-justify-center">
                    <i class="fas fa-draw-polygon"></i>
                  </div>
                  <div>
                    <div class="avitar-font-semibold avitar-mb-1">Polygon Tool Instructions:</div>
                    <ol class="avitar-list-decimal avitar-ml-4 avitar-space-y-1">
                      <li><strong>Left click:</strong> Add vertices to create your custom shape (minimum 3 points)</li>
                      <li><strong>Hold Shift:</strong> Constrain lines to be perpendicular to the previous segment (90Â° angles)</li>
                      <li><strong>Right click:</strong> Complete the polygon and close the shape</li>
                    </ol>
                    <div class="avitar-mt-2 avitar-text-muted">
                      <i class="fas fa-lightbulb avitar-mr-1"></i>
                      <strong>Tip:</strong> Each vertex snaps to the grid. The start point is marked with a red dot. Use Shift for perfectly perpendicular walls.
                    </div>
                  </div>
                </div>
              {{else if (eq this.drawingMode "arc-segment")}}
                <div class="avitar-flex avitar-items-start avitar-gap-3">
                  <div class="avitar-flex-shrink-0 avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary avitar-text-white avitar-flex avitar-items-center avitar-justify-center">
                    <i class="fas fa-bezier-curve"></i>
                  </div>
                  <div>
                    <div class="avitar-font-semibold avitar-mb-1">Arc Segment Tool Instructions:</div>
                    <div class="avitar-mb-2 avitar-text-muted avitar-italic">
                      This tool adds curved edges to polygons and rectangles. Rectangles will be automatically converted to polygons when you add an arc.
                    </div>

                    <div class="avitar-mb-3">
                      <div class="avitar-font-semibold avitar-text-sm avitar-mb-1">Creating a New Arc:</div>
                      <ol class="avitar-list-decimal avitar-ml-4 avitar-space-y-1">
                        <li><strong>First click:</strong> Click on a polygon or rectangle edge where you want the arc to start</li>
                        <li><strong>Second click:</strong> Click on the same or another edge where the arc should end</li>
                        <li><strong>Third click:</strong> Click where you want the arc to curve - this sets both the radius and direction</li>
                      </ol>
                    </div>

                    <div class="avitar-mb-2">
                      <div class="avitar-font-semibold avitar-text-sm avitar-mb-1">Editing an Existing Arc:</div>
                      <ul class="avitar-list-disc avitar-ml-4">
                        <li>Click on an arc segment to open the arc value editor</li>
                        <li>Enter a positive or negative value to adjust the curve</li>
                      </ul>
                    </div>

                    <div class="avitar-mt-2 avitar-text-muted">
                      <i class="fas fa-lightbulb avitar-mr-1"></i>
                      <strong>Tip:</strong> The arc curves toward whichever side of the line you click. Positive values = curve right, negative values = curve left. Watch the red preview!
                    </div>
                  </div>
                </div>
              {{/if}}
            </div>
          </div>
        {{/if}}
      </div>

      <div class="avitar-modal__footer">
        <button 
          type="button" 
          class="avitar-btn avitar-btn--secondary"
          {{on "click" @onClose}}
        >
          Cancel
        </button>
        <button 
          type="button" 
          class="avitar-btn avitar-btn--primary"
          {{on "click" this.handleSave}}
        >
          <i class="fas fa-save avitar-mr-2"></i>
          Save Sketch
        </button>
      </div>
    </div>
  </div>
{{/if}}
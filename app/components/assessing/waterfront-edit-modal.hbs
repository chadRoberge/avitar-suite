{{#if @isOpen}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" @onClose}}>
    <div class="avitar-modal avitar-modal--lg" {{on "click" this.stopPropagation}}>
      <div class="avitar-modal__header">
        <h2 class="avitar-modal__title">{{if @waterfront "Edit Waterfront" "Add Waterfront"}}</h2>
        <button type="button" class="avitar-modal__close" {{on "click" @onClose}}>
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form {{on "submit" this.handleSubmit}} class="avitar-modal__body">
        <div class="avitar-grid avitar-grid-cols-2 avitar-gap-6">
          {{!-- Water Body Selection --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="water-body">
              Water Body <span class="avitar-text-danger">*</span>
            </label>
            <select
              id="water-body"
              class="avitar-select"
              {{on "change" this.updateWaterBody}}
              required
            >
              <option value="">Select Water Body</option>
              {{#each @waterBodies as |waterBody|}}
                <option value={{or waterBody.id waterBody._id}} selected={{if (eq this.formData.water_body_id (or waterBody.id waterBody._id)) "selected"}}>
                  {{waterBody.name}}
                </option>
              {{/each}}
            </select>
          </div>

          {{!-- Frontage --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="frontage">
              Frontage (feet) <span class="avitar-text-danger">*</span>
            </label>
            <input
              id="frontage"
              type="number"
              class="avitar-input"
              value={{this.formData.frontage}}
              {{on "input" this.updateFrontage}}
              min="0"
              step="0.1"
              required
            />
          </div>

          {{!-- Water Access --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="access">
              Water Access <span class="avitar-text-danger">*</span>
            </label>
            <select
              id="access"
              class="avitar-select"
              {{on "change" this.updateAccess}}
              required
            >
              <option value="">Select Water Access</option>
              {{#each this.accessAttributes as |accessAttr|}}
                <option value={{accessAttr._id}} selected={{if (eq this.formData.access_id accessAttr._id) "selected"}}>
                  {{accessAttr.displayText}} (Factor: {{accessAttr.factor}})
                </option>
              {{/each}}
            </select>
          </div>

          {{!-- Topography --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="topography">
              Topography <span class="avitar-text-danger">*</span>
            </label>
            <select
              id="topography"
              class="avitar-select"
              {{on "change" this.updateTopography}}
              required
            >
              <option value="">Select Topography</option>
              {{#each this.topographyAttributes as |topoAttr|}}
                <option value={{topoAttr._id}} selected={{if (eq this.formData.topography_id topoAttr._id) "selected"}}>
                  {{topoAttr.displayText}} (Factor: {{topoAttr.factor}})
                </option>
              {{/each}}
            </select>
          </div>

          {{!-- Water Location --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="location">
              Water Location <span class="avitar-text-danger">*</span>
            </label>
            <select
              id="location"
              class="avitar-select"
              {{on "change" this.updateLocation}}
              required
            >
              <option value="">Select Water Location</option>
              {{#each this.locationAttributes as |locationAttr|}}
                <option value={{locationAttr._id}} selected={{if (eq this.formData.location_id locationAttr._id) "selected"}}>
                  {{locationAttr.displayText}} (Factor: {{locationAttr.factor}})
                </option>
              {{/each}}
            </select>
          </div>

          {{!-- Condition Percentage --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="condition">
              Condition %
            </label>
            <input
              id="condition"
              type="number"
              class="avitar-input"
              value={{this.formData.condition}}
              {{on "input" this.updateCondition}}
              min="0"
              max="100"
              step="1"
            />
            <div class="avitar-text-xs avitar-text-muted avitar-mt-1">
              Condition factor (0-100%) - Default is 100%
            </div>
          </div>

          {{!-- Current Use Checkbox --}}
          <div class="avitar-form-group">
            <label class="avitar-label avitar-flex avitar-items-center">
              <input
                type="checkbox"
                class="avitar-checkbox avitar-mr-2"
                checked={{this.formData.current_use}}
                {{on "change" this.updateCurrentUse}}
              />
              Current Use
            </label>
            <div class="avitar-text-xs avitar-text-muted avitar-mt-1">
              If checked, waterfront value will not be assessed
            </div>
          </div>

          {{!-- Calculated Value (read-only) --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="calculated-waterfront-value">
              Market Value
            </label>
            <input
              id="calculated-waterfront-value"
              type="text"
              class="avitar-input"
              value="${{number-format this.calculatedValue}}"
              readonly
            />
            <div class="avitar-text-xs avitar-text-muted avitar-mt-1">
              Base × Frontage Factor × Access × Topography × Location × Condition
            </div>
          </div>

          {{!-- Assessed Value (read-only) --}}
          <div class="avitar-form-group">
            <label class="avitar-label" for="assessed-waterfront-value">
              Assessed Value
            </label>
            <input
              id="assessed-waterfront-value"
              type="text"
              class="avitar-input {{if this.formData.current_use 'avitar-text-muted'}}"
              value="${{number-format this.assessedValue}}"
              readonly
            />
            <div class="avitar-text-xs avitar-text-muted avitar-mt-1">
              {{#if this.formData.current_use}}
                Not assessed (Current Use)
              {{else}}
                Same as market value
              {{/if}}
            </div>
          </div>
        </div>

        {{!-- Waterfront Calculation Details --}}
        {{#if this.selectedWaterBody}}
          <div class="avitar-mt-6 avitar-p-4 avitar-bg-blue-50 avitar-rounded">
            <h6 class="avitar-mb-3">Waterfront Calculation Details</h6>
            <div class="avitar-grid avitar-grid-cols-3 avitar-gap-4 avitar-text-sm avitar-mb-3">
              <div>
                <span class="avitar-text-muted">Base Value:</span>
                <div class="avitar-font-semibold">${{number-format this.waterBodyBaseValue}}</div>
              </div>
              <div>
                <span class="avitar-text-muted">Frontage (for lookup):</span>
                <div class="avitar-font-semibold">{{this.formData.frontage}} ft</div>
              </div>
              <div>
                <span class="avitar-text-muted">Total Factor:</span>
                <div class="avitar-font-semibold">{{number-format this.totalFactor 3}}x</div>
              </div>
            </div>
            <div class="avitar-grid avitar-grid-cols-5 avitar-gap-4 avitar-text-sm avitar-mb-3">
              <div>
                <span class="avitar-text-muted">Frontage Factor:</span>
                <div class="avitar-font-semibold avitar-text-primary">{{number-format this.frontageFactor 3}}x</div>
              </div>
              <div>
                <span class="avitar-text-muted">Access:</span>
                <div class="avitar-font-semibold">{{number-format this.accessFactor 2}}x</div>
              </div>
              <div>
                <span class="avitar-text-muted">Topography:</span>
                <div class="avitar-font-semibold">{{number-format this.topographyFactor 2}}x</div>
              </div>
              <div>
                <span class="avitar-text-muted">Location:</span>
                <div class="avitar-font-semibold">{{number-format this.locationFactor 2}}x</div>
              </div>
              <div>
                <span class="avitar-text-muted">Condition:</span>
                <div class="avitar-font-semibold">{{number-format this.conditionFactor 2}}x</div>
              </div>
            </div>
            <div class="avitar-mt-3 avitar-text-sm avitar-text-muted">
              Calculation: Base × Total Factor =
              ${{number-format this.waterBodyBaseValue}} × {{number-format this.totalFactor 3}} =
              <span class="avitar-font-semibold avitar-text-success">${{number-format this.calculatedValue}}</span>
            </div>
            <div class="avitar-text-xs avitar-text-muted avitar-mt-2">
              Total Factor = Frontage Factor ({{number-format this.frontageFactor 3}}) × Access ({{number-format this.accessFactor 2}}) × Topography ({{number-format this.topographyFactor 2}}) × Location ({{number-format this.locationFactor 2}}) × Condition ({{number-format this.conditionFactor 2}})
            </div>
            {{#if this.formData.current_use}}
              <div class="avitar-mt-2 avitar-text-sm avitar-font-semibold avitar-text-warning">
                ⚠️ Current Use: Assessed Value = $0
              </div>
            {{/if}}
          </div>
        {{/if}}

        <div class="avitar-modal__footer">
          <button type="button" class="avitar-btn avitar-btn--secondary" {{on "click" @onClose}}>
            Cancel
          </button>
          <button type="submit" class="avitar-btn avitar-btn--primary" disabled={{not this.isValid}}>
            {{if @waterfront "Update Waterfront" "Add Waterfront"}}
          </button>
        </div>
      </form>
    </div>
  </div>
{{/if}}
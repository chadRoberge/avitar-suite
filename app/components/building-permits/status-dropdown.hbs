<div class="avitar-dropdown avitar-relative" {{on "click" this.stopPropagation}}>
  {{! Dropdown Button }}
  <button
    type="button"
    class="avitar-btn avitar-btn--{{this.currentStatusOption.color}} avitar-btn--sm"
    {{on "click" this.toggleDropdown}}
    disabled={{this.isChanging}}
  >
    {{lnr-icon "cog" class="avitar-mr-2"}}
    Change Status
    {{lnr-icon "chevron-down" class="avitar-ml-2"}}
  </button>

  {{! Dropdown Menu }}
  {{#if this.isOpen}}
    <div
      class="avitar-dropdown__menu avitar-dropdown__menu--right avitar-shadow-lg"
      style="min-width: 200px;"
      {{on "click" this.stopPropagation}}
    >
      <div class="avitar-dropdown__header avitar-p-3 avitar-border-b">
        <h4 class="avitar-font-semibold avitar-text-sm">Change Inspection Status</h4>
      </div>

      <div class="avitar-p-2">
        <div class="avitar-flex avitar-flex-col avitar-gap-2">
          {{#each this.availableStatusOptions as |statusOption|}}
            <button
              type="button"
              class="avitar-btn avitar-btn--{{statusOption.color}} avitar-btn--sm avitar-w-full avitar-justify-start"
              {{on "click" (fn this.selectStatus statusOption.value)}}
            >
              {{lnr-icon "chevron-right" class="avitar-mr-2"}}
              {{statusOption.label}}
            </button>
          {{/each}}
        </div>
      </div>
    </div>

    {{! Overlay to close dropdown when clicking outside }}
    {{#unless this.showConfirmModal}}
      <div class="avitar-fixed avitar-inset-0 avitar-z-10" {{on "click" this.closeDropdown}}></div>
    {{/unless}}
  {{/if}}
</div>

{{! Confirmation Modal - Rendered at document root to prevent positioning issues }}
{{#if this.showConfirmModal}}
  {{#in-element this.destinationElement insertBefore=null}}
    <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.closeConfirmModal}}>
      <div class="avitar-modal avitar-modal--md" {{on "click" this.stopPropagation}}>
        <div class="avitar-modal__header">
          <h2 class="avitar-modal__title">
            {{#if (eq this.selectedStatus "completed")}}
              {{lnr-icon "checkmark-circle" class="avitar-mr-2"}}
              Complete Inspection
            {{else if (eq this.selectedStatus "cancelled")}}
              {{lnr-icon "cross-circle" class="avitar-mr-2"}}
              Cancel Inspection
            {{/if}}
          </h2>
          <button type="button" class="avitar-modal__close" {{on "click" this.closeConfirmModal}}>
            {{lnr-icon "cross"}}
          </button>
        </div>

        <div class="avitar-modal__body">
          <p class="avitar-mb-4">
            {{#if (eq this.selectedStatus "completed")}}
              Please provide any final comments or notes about this inspection:
            {{else if (eq this.selectedStatus "cancelled")}}
              Please provide a reason for cancelling this inspection:
            {{/if}}
          </p>

          <div>
            <label class="avitar-label">
              {{#if (eq this.selectedStatus "completed")}}
                Completion Notes
              {{else if (eq this.selectedStatus "cancelled")}}
                Cancellation Reason
              {{/if}}
            </label>
            <textarea
              class="avitar-input"
              rows="4"
              placeholder={{if (eq this.selectedStatus "completed")
                "Enter completion notes..."
                "Enter cancellation reason..."
              }}
              value={{this.completionNotes}}
              {{on "input" this.updateCompletionNotes}}
            ></textarea>
          </div>

          {{#if (eq this.selectedStatus "completed")}}
            <div class="avitar-alert avitar-alert--info avitar-mt-4">
              {{lnr-icon "question-circle" class="avitar-mr-2"}}
              Ensure all required checklist items are completed before marking this inspection as complete.
            </div>
          {{/if}}
        </div>

        <div class="avitar-modal__footer">
          <button
            type="button"
            class="avitar-btn avitar-btn--secondary"
            {{on "click" this.closeConfirmModal}}
            disabled={{this.isChanging}}
          >
            Cancel
          </button>
          <button
            type="button"
            class="avitar-btn avitar-btn--{{if (eq this.selectedStatus 'completed') 'success' 'danger'}}"
            {{on "click" this.changeStatus}}
            disabled={{this.isChanging}}
          >
            {{#if this.isChanging}}
              {{lnr-icon "sync" class="avitar-mr-2 avitar-spin"}}
              Updating...
            {{else}}
              {{#if (eq this.selectedStatus "completed")}}
                {{lnr-icon "checkmark-circle" class="avitar-mr-2"}}
                Complete Inspection
              {{else if (eq this.selectedStatus "cancelled")}}
                {{lnr-icon "cross-circle" class="avitar-mr-2"}}
                Cancel Inspection
              {{/if}}
            {{/if}}
          </button>
        </div>
      </div>
    </div>
  {{/in-element}}
{{/if}}

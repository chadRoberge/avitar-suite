{{page-title "My Permits Dashboard"}}
{{! Permits Management Section }}
<div class="avitar-card">
  <div class="avitar-card__header avitar-bg-gray-50">
    <div class="avitar-tabs">
      <button type="button" class="avitar-tab {{if (eq this.selectedTab 'all') 'avitar-tab--active'}}" {{on "click" (fn this.selectTab "all")}}>
        <i class="fas fa-list avitar-mr-1"></i>
        All Permits
        <span class="avitar-badge avitar-badge--secondary avitar-ml-2">
          {{this.tabStats.all}}
        </span>
      </button>
      <button type="button" class="avitar-tab {{if (eq this.selectedTab 'active') 'avitar-tab--active'}}" {{on "click" (fn this.selectTab "active")}}>
        <i class="fas fa-tasks avitar-mr-1"></i>
        Active
        <span class="avitar-badge avitar-badge--info avitar-ml-2">
          {{this.tabStats.active}}
        </span>
      </button>
      <button type="button" class="avitar-tab {{if (eq this.selectedTab 'draft') 'avitar-tab--active'}}" {{on "click" (fn this.selectTab "draft")}}>
        <i class="fas fa-edit avitar-mr-1"></i>
        Drafts
        <span class="avitar-badge avitar-badge--warning avitar-ml-2">
          {{this.tabStats.draft}}
        </span>
      </button>
      <button type="button" class="avitar-tab {{if (eq this.selectedTab 'completed') 'avitar-tab--active'}}" {{on "click" (fn this.selectTab "completed")}}>
        <i class="fas fa-check-circle avitar-mr-1"></i>
        Completed
        <span class="avitar-badge avitar-badge--success avitar-ml-2">
          {{this.tabStats.completed}}
        </span>
      </button>
      <div style="margin-left: auto; display: flex; gap: 0.5rem;">
        <button type="button" class="avitar-tab" {{on "click" this.refreshPermits}} title="Refresh">
          <span class="avitar-text-primary" style="font-size: 1.25rem;">
            {{{lnr-icon "sync"}}}
          </span>
        </button>
        <button type="button" class="avitar-tab" {{on "click" this.createNewPermit}} title="New Application">
          <span class="avitar-text-success" style="font-size: 1.25rem;">
            {{{lnr-icon "plus-circle"}}}
          </span>
        </button>
      </div>
    </div>
  </div>
  <div class="avitar-card__body">
    {{! Search and Filter Bar }}
    <div class="avitar-mb-4">
      <div class="avitar-flex avitar-gap-3 avitar-items-end">
        {{! Search Input }}
        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            <i class="fas fa-search avitar-mr-1"></i>
            Search Permits
          </label>
          <input type="text" class="avitar-input" placeholder="Search by permit #, address, or description..." value={{this.searchText}} {{on "input" this.updateSearch}} />
        </div>
        {{! Municipality Filter }}
        <div style="min-width: 200px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Municipality
          </label>
          <select class="avitar-select" {{on "change" this.setFilterMunicipality}}>
            {{#each this.municipalityOptions as |munOption|}}
            <option value={{munOption.value}} selected={{eq this.filterMunicipality munOption.value}}>
              {{munOption.label}}
            </option>
            {{/each}}
          </select>
        </div>
        {{! Status Filter }}
        <div style="min-width: 180px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Status
          </label>
          <select class="avitar-select" {{on "change" this.setFilterStatus}}>
            {{#each this.statusOptions as |statusOption|}}
            <option value={{statusOption.value}} selected={{eq this.filterStatus statusOption.value}}>
              {{statusOption.label}}
            </option>
            {{/each}}
          </select>
        </div>
        {{! Sort By }}
        <div style="min-width: 160px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Sort By
          </label>
          <select class="avitar-select" {{on "change" this.setSortBy}}>
            {{#each this.sortOptions as |sortOption|}}
            <option value={{sortOption.value}} selected={{eq this.sortBy sortOption.value}}>
              {{sortOption.label}}
            </option>
            {{/each}}
          </select>
        </div>
        {{! Clear Filters Button }}
        {{#if this.hasFiltersApplied}}
        <div>
          <button type="button" class="avitar-btn avitar-btn--ghost avitar-btn--secondary" {{on "click" this.clearFilters}} title="Clear all filters">
            <i class="fas fa-times"></i>
          </button>
        </div>
        {{/if}}
      </div>
      {{! Active Filters Display }}
      {{#if this.hasFiltersApplied}}
      <div class="avitar-flex avitar-gap-2 avitar-mt-3">
        <span class="avitar-text-sm avitar-text-muted">Active filters:</span>
        {{#if this.searchText}}
        <span class="avitar-badge avitar-badge--secondary">
          Search: "{{this.searchText}}"
          <button type="button" class="avitar-ml-1" {{on "click" (fn this.updateSearch (hash target (hash value "")))}}>
            <i class="fas fa-times"></i>
          </button>
        </span>
        {{/if}}
        {{#if (ne this.filterMunicipality "all")}}
        <span class="avitar-badge avitar-badge--secondary">
          Municipality
          <button type="button" class="avitar-ml-1" {{on "click" (fn this.setFilterMunicipality (hash target (hash value "all")))}}>
            <i class="fas fa-times"></i>
          </button>
        </span>
        {{/if}}
        {{#if (ne this.filterStatus "all")}}
        <span class="avitar-badge avitar-badge--secondary">
          Status: {{this.filterStatus}}
          <button type="button" class="avitar-ml-1" {{on "click" (fn this.setFilterStatus (hash target (hash value "all")))}}>
            <i class="fas fa-times"></i>
          </button>
        </span>
        {{/if}}
      </div>
      {{/if}}
    </div>
    {{! Results Summary and View Mode Toggle }}
    <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-3 avitar-pb-3 avitar-border-b">
      <div class="avitar-text-sm avitar-text-muted">
        <i class="fas fa-list-ul avitar-mr-1"></i>
        Showing
        <strong>{{if (eq this.viewMode "grouped") this.groupedData.length this.displayedPermits.length}}</strong>
        {{#if (eq this.viewMode "grouped")}}
        {{#if (eq this.groupedData.length 1)}}
        item
        {{else}}
        items
        {{/if}}
        {{else}}
        {{#if (eq this.displayedPermits.length 1)}}
        permit
        {{else}}
        permits
        {{/if}}
        {{/if}}
      </div>
      {{! View Mode Toggle }}
      <div class="avitar-btn-group">
        <button type="button" class="avitar-btn avitar-btn--sm {{if (eq this.viewMode 'list') 'avitar-btn--primary' 'avitar-btn--secondary'}}" {{on "click" (fn this.setViewMode "list")}} title="List View">
          <i class="fas fa-list"></i>
          List
        </button>
        <button type="button" class="avitar-btn avitar-btn--sm {{if (eq this.viewMode 'grouped') 'avitar-btn--primary' 'avitar-btn--secondary'}}" {{on "click" (fn this.setViewMode "grouped")}} title="Grouped View (Projects)">
          <i class="fas fa-folder-open"></i>
          Grouped
        </button>
      </div>
    </div>
    {{! List View (Table) }}
    {{#if (eq this.viewMode "list")}}
    {{#if this.displayedPermits.length}}
    <div class="avitar-table-container">
      <table class="avitar-table avitar-table--hover avitar-table--striped">
        <thead>
          <tr>
            <th style="width: 100px;">Permit #</th>
            <th style="width: auto;">Municipality</th>
            <th style="width: 110px;">Type</th>
            <th style="width: auto;">Property</th>
            <th style="width: auto;">Description</th>
            <th style="width: 100px;">Status</th>
            <th style="width: 90px;">Applied</th>
            <th style="width: 100px;" class="avitar-text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          {{#each this.displayedPermits as |permit|}}
          <tr class="avitar-cursor-pointer" {{on "click" (fn this.viewPermit permit)}}>
            <td>
              <div class="avitar-font-medium avitar-text-primary">
                {{permit.permitNumber}}
              </div>
            </td>
            <td>
              <div class="avitar-text-sm avitar-font-medium">
                {{permit.municipalityId.name}}
              </div>
            </td>
            <td>
              <div class="avitar-text-sm">
                {{permit.type}}
              </div>
            </td>
            <td>
              <div class="avitar-text-sm">
                <div class="avitar-font-medium avitar-text-gray-900 avitar-truncate">
                  {{permit.pidFormatted}}
                </div>
                <div class="avitar-text-muted avitar-truncate">
                  {{permit.propertyAddress}}
                </div>
              </div>
            </td>
            <td>
              <div class="avitar-text-sm avitar-truncate" style="max-width: 300px;">
                {{permit.description}}
              </div>
            </td>
            <td>
              <span class={{permit.statusBadge.class}}>
                {{permit.statusBadge.text}}
              </span>
            </td>
            <td>
              <div class="avitar-text-sm avitar-text-muted">
                {{date-format permit.applicationDate "MMM DD, YYYY"}}
              </div>
            </td>
            <td {{on "click" this.stopPropagation}}>
              <div class="avitar-flex avitar-justify-center avitar-gap-1">
                <button type="button" class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary" {{on "click" (fn this.viewPermit permit)}} title="View Details">
                  {{{lnr-icon "eye"}}}
                </button>
                {{#if (eq permit.status "draft")}}
                <button type="button" class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary" {{on "click" (fn this.deletePermit permit)}} title="Delete Draft" style="border-color: transparent;" onmouseover="this.style.borderColor='var(--color-danger)'; this.style.backgroundColor='transparent';" onmouseout="this.style.borderColor='transparent';">
                  <span class="avitar-text-danger">
                    {{{lnr-icon "trash"}}}
                  </span>
                </button>
                {{/if}}
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
    {{else}}
    <div class="avitar-empty-state avitar-py-6">
      <div class="avitar-flex avitar-flex-col avitar-items-center avitar-justify-center">
        {{#if this.hasFiltersApplied}}
        <div class="avitar-mb-4 avitar-text-center">
          <i class="fas fa-filter fa-3x avitar-text-muted"></i>
        </div>
        <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">
          No Permits Match Your Filters
        </h3>
        <p class="avitar-text-muted avitar-mb-4 avitar-text-center" style="max-width: 400px;">
          We couldn't find any permits matching your current search criteria. Try adjusting
          your filters to see more results.
        </p>
        <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.clearFilters}}>
          <i class="fas fa-times-circle avitar-mr-2"></i>
          Clear All Filters
        </button>
        {{else}}
        <div class="avitar-mb-4 avitar-text-center">
          <div class="avitar-flex avitar-items-center avitar-justify-center avitar-mb-3">
            <div class="avitar-stat__icon avitar-stat__icon--lg avitar-bg-primary-light avitar-text-primary">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>
        </div>
        <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">No Permits Yet</h3>
        <p class="avitar-text-muted avitar-mb-4 avitar-text-center" style="max-width: 450px;">
          Get started by creating your first permit application. Our streamlined process makes
          it easy to submit and track building permits.
        </p>
        <button type="button" class="avitar-btn avitar-btn--primary avitar-btn--lg" {{on "click" this.createNewPermit}}>
          <i class="fas fa-plus-circle avitar-mr-2"></i>
          Create First Application
        </button>
        {{/if}}
      </div>
    </div>
    {{/if}}
    {{! End of List View }}
    {{! Grouped View (Projects and Standalone Permits) }}
    {{else}}
    {{#if this.groupedData.length}}
    <div class="avitar-space-y-4">
      {{#each this.groupedData as |group|}}
      {{#if (eq group.type "project")}}
      {{! Project Card }}
      <div class="avitar-card avitar-card--hover" {{on "click" (fn this.viewProject group.project)}}>
        <div class="avitar-card__body">
          <div class="avitar-flex avitar-items-start avitar-justify-between avitar-gap-4">
            <div class="avitar-flex avitar-items-start avitar-gap-3 avitar-flex-1">
              <div class="avitar-icon-wrapper avitar-bg-primary-light avitar-text-primary">
                <i class="fas fa-folder-open"></i>
              </div>
              <div class="avitar-flex-1">
                <div class="avitar-flex avitar-items-center avitar-gap-2 avitar-mb-1">
                  <h3 class="avitar-font-semibold avitar-text-lg">
                    {{group.project.projectName}}
                  </h3>
                  <span class={{group.statusBadge.class}}>
                    {{group.statusBadge.text}}
                  </span>
                </div>
                <div class="avitar-flex avitar-gap-4 avitar-text-sm avitar-text-muted avitar-mb-2">
                  <div>
                    <i class="fas fa-hashtag avitar-mr-1"></i>
                    {{group.project.permitNumber}}
                  </div>
                  <div>
                    <i class="fas fa-map-marker-alt avitar-mr-1"></i>
                    {{group.project.propertyAddress}}
                  </div>
                  <div>
                    <i class="fas fa-building avitar-mr-1"></i>
                    {{group.project.municipalityId.name}}
                  </div>
                  <div>
                    <i class="fas fa-calendar avitar-mr-1"></i>
                    {{date-format group.project.applicationDate "MMM DD, YYYY"}}
                  </div>
                </div>
                <div class="avitar-flex avitar-gap-3 avitar-items-center">
                  <span class="avitar-badge avitar-badge--primary avitar-badge--sm">
                    <i class="fas fa-file-alt avitar-mr-1"></i>
                    {{group.project.projectStats.totalChildren}} permits
                  </span>
                  {{#if group.project.projectStats.completedChildren}}
                  <span class="avitar-badge avitar-badge--success avitar-badge--sm">
                    <i class="fas fa-check avitar-mr-1"></i>
                    {{group.project.projectStats.completedChildren}} completed
                  </span>
                  {{/if}}
                  {{#if group.project.projectTotalFee}}
                  <span class="avitar-badge avitar-badge--info avitar-badge--sm">
                    <i class="fas fa-dollar-sign avitar-mr-1"></i>
                    ${{group.project.projectTotalFee}} total
                  </span>
                  {{/if}}
                </div>
              </div>
            </div>
            <button type="button" class="avitar-btn avitar-btn--ghost avitar-btn--sm" {{on "click" (fn this.viewProject group.project)}}>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
      {{else}}
      {{! Standalone Permit Card }}
      <div class="avitar-card avitar-card--hover" {{on "click" (fn this.viewPermit group.permit)}}>
        <div class="avitar-card__body avitar-py-3">
          <div class="avitar-flex avitar-items-start avitar-justify-between avitar-gap-4">
            <div class="avitar-flex avitar-items-start avitar-gap-3 avitar-flex-1">
              <div class="avitar-icon-wrapper avitar-bg-secondary-light avitar-text-secondary">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="avitar-flex-1">
                <div class="avitar-flex avitar-items-center avitar-gap-2 avitar-mb-1">
                  <h3 class="avitar-font-semibold">
                    {{group.permit.permitNumber}}
                  </h3>
                  <span class={{group.statusBadge.class}}>
                    {{group.statusBadge.text}}
                  </span>
                </div>
                <div class="avitar-text-sm avitar-text-muted avitar-mb-2">
                  {{group.permit.description}}
                </div>
                <div class="avitar-flex avitar-gap-4 avitar-text-xs avitar-text-muted">
                  <div>
                    <i class="fas fa-map-marker-alt avitar-mr-1"></i>
                    {{group.permit.propertyAddress}}
                  </div>
                  <div>
                    <i class="fas fa-building avitar-mr-1"></i>
                    {{group.permit.municipalityId.name}}
                  </div>
                  <div>
                    <i class="fas fa-tag avitar-mr-1"></i>
                    {{group.permit.type}}
                  </div>
                  <div>
                    <i class="fas fa-calendar avitar-mr-1"></i>
                    {{date-format group.permit.applicationDate "MMM DD, YYYY"}}
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="avitar-btn avitar-btn--ghost avitar-btn--sm" {{on "click" (fn this.viewPermit group.permit)}}>
              <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </div>
      </div>
      {{/if}}
      {{/each}}
    </div>
    {{else}}
    {{! Empty State for Grouped View }}
    <div class="avitar-empty-state avitar-py-6">
      <div class="avitar-flex avitar-flex-col avitar-items-center avitar-justify-center">
        <div class="avitar-mb-4 avitar-text-center">
          <i class="fas fa-folder-open fa-3x avitar-text-muted"></i>
        </div>
        <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">
          No Projects or Permits Found
        </h3>
        <p class="avitar-text-muted avitar-mb-4 avitar-text-center" style="max-width: 400px;">
          {{#if this.hasFiltersApplied}}
          No items match your current filters. Try adjusting your filters to see more results.
          {{else}}
          Get started by creating your first permit or project.
          {{/if}}
        </p>
        {{#if this.hasFiltersApplied}}
        <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.clearFilters}}>
          <i class="fas fa-times-circle avitar-mr-2"></i>
          Clear Filters
        </button>
        {{else}}
        <button type="button" class="avitar-btn avitar-btn--primary avitar-btn--lg" {{on "click" this.createNewPermit}}>
          <i class="fas fa-plus-circle avitar-mr-2"></i>
          Create First Application
        </button>
        {{/if}}
      </div>
    </div>
    {{/if}}
    {{/if}}
    {{! End of Grouped View }}
  </div>
</div>
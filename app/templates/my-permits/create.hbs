{{page-title "Create New Permit"}}

<div class="avitar-container avitar-py-6">
  {{! Header }}
  <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-6">
    <div>
      <h1 class="avitar-text-2xl avitar-font-bold avitar-text-gray-900">
        <i class="fas fa-plus-circle avitar-mr-2 avitar-text-primary"></i>
        New Permit Application
      </h1>
      <p class="avitar-text-sm avitar-text-muted avitar-mt-1">
        {{#if @model.isContractor}}
          Submit a permit application on behalf of your company
        {{else}}
          Submit a new building permit application
        {{/if}}
      </p>
    </div>

    <button
      type="button"
      class="avitar-btn avitar-btn--ghost avitar-btn--secondary"
      {{on "click" this.cancel}}
    >
      <i class="fas fa-times avitar-mr-2"></i>
      Cancel
    </button>
  </div>

  {{! Step Progress }}
  <div class="avitar-step-progress">
    {{#each this.steps as |step index|}}
      {{! Step }}
      <div
        class="avitar-step-progress__step
          {{if (eq this.currentStep step.number) 'avitar-step-progress__step--active'
            (if (gt this.currentStep step.number) 'avitar-step-progress__step--completed' 'avitar-step-progress__step--pending')}}"
        {{on "click" (fn this.goToStep step.number)}}
        style="cursor: pointer;"
      >
        <div class="avitar-step-progress__number">
          {{#if (gt this.currentStep step.number)}}
            <i class="fas fa-check avitar-step-progress__icon"></i>
          {{else}}
            <i class="fas fa-{{step.icon}} avitar-step-progress__icon"></i>
          {{/if}}
        </div>
        <div class="avitar-step-progress__label">{{step.name}}</div>
      </div>

      {{! Connector (not after last step) }}
      {{#unless (eq step.number 5)}}
        <div
          class="avitar-step-progress__connector
            {{if (gt this.currentStep step.number) 'avitar-step-progress__connector--completed'
              (if (eq this.currentStep step.number) 'avitar-step-progress__connector--active')}}"
        ></div>
      {{/unless}}
    {{/each}}
  </div>

  {{! Wizard Content }}
  <div class="avitar-card">
    <div class="avitar-card__body avitar-p-6">
      {{! Step 1: Municipality Selection }}
      {{#if (eq this.currentStep 1)}}
        <div>
          <h2 class="avitar-text-xl avitar-font-semibold avitar-mb-4">
            Select Municipality
          </h2>
          <p class="avitar-text-muted avitar-mb-6">
            Choose the municipality where the permit will be filed
          </p>

          {{#if @model.municipalities.length}}
            <div class="avitar-grid avitar-grid-cols-1 md:avitar-grid-cols-2 lg:avitar-grid-cols-3 avitar-gap-3">
              {{#each @model.municipalities as |municipality|}}
                <div
                  class="avitar-card avitar-card--hover avitar-cursor-pointer avitar-transition-all
                    {{if (eq this.selectedMunicipality.id municipality.id) 'avitar-bg-success avitar-border-success'}}"
                  {{on "click" (fn this.selectMunicipality municipality)}}
                >
                  <div class="avitar-card__body avitar-p-3">
                    <div class="avitar-flex avitar-items-center avitar-gap-2">
                      <div class="avitar-flex-shrink-0">
                        <div
                          class="avitar-w-8 avitar-h-8 avitar-rounded-full avitar-flex avitar-items-center avitar-justify-center
                            {{if (eq this.selectedMunicipality.id municipality.id)
                              'avitar-bg-white avitar-text-success'
                              'avitar-bg-primary-light avitar-text-primary'}}"
                        >
                          <i class="fas fa-{{if (eq this.selectedMunicipality.id municipality.id) 'check' 'map-marker-alt'}} avitar-text-sm"></i>
                        </div>
                      </div>
                      <div class="avitar-flex-1">
                        <h3 class="avitar-font-semibold avitar-text-sm {{if (eq this.selectedMunicipality.id municipality.id) 'avitar-text-white' 'avitar-text-gray-900'}}">
                          {{municipality.name}}
                        </h3>
                      </div>
                    </div>
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="avitar-empty-state avitar-py-8">
              <i class="fas fa-exclamation-triangle fa-3x avitar-text-warning avitar-mb-4"></i>
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
                No Municipalities Available
              </h3>
              <p class="avitar-text-muted avitar-text-center" style="max-width: 400px;">
                No municipalities are currently available. Please contact support.
              </p>
            </div>
          {{/if}}
        </div>
      {{/if}}

      {{! Step 2: Property Selection }}
      {{#if (eq this.currentStep 2)}}
        <div>
          <h2 class="avitar-text-xl avitar-font-semibold avitar-mb-4">
            Select Property
          </h2>
          <p class="avitar-text-muted avitar-mb-6">
            Search for the property address or PID, or browse all properties
          </p>

          {{! View Mode Toggle }}
          <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-4">
            <div class="avitar-flex avitar-gap-2">
              <button
                type="button"
                class="avitar-btn avitar-btn--sm {{if (eq this.viewMode 'list') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
                {{on "click" (fn this.setViewMode "list")}}
              >
                <i class="fas fa-search avitar-mr-2"></i>
                Search
              </button>
              <button
                type="button"
                class="avitar-btn avitar-btn--sm {{if (eq this.viewMode 'tree') 'avitar-btn--primary' 'avitar-btn--secondary'}}"
                {{on "click" (fn this.setViewMode "tree")}}
              >
                <i class="fas fa-list avitar-mr-2"></i>
                Browse All
              </button>
            </div>

            {{#if (eq this.viewMode "tree")}}
              <div class="avitar-flex avitar-gap-2">
                <label class="avitar-text-sm avitar-text-muted avitar-mr-2">Group by:</label>
                <button
                  type="button"
                  class="avitar-btn avitar-btn--xs {{if (eq this.groupBy 'pid') 'avitar-btn--primary' 'avitar-btn--ghost'}}"
                  {{on "click" (fn this.setGroupBy "pid")}}
                >
                  PID
                </button>
                <button
                  type="button"
                  class="avitar-btn avitar-btn--xs {{if (eq this.groupBy 'street') 'avitar-btn--primary' 'avitar-btn--ghost'}}"
                  {{on "click" (fn this.setGroupBy "street")}}
                >
                  Street
                </button>
                <button
                  type="button"
                  class="avitar-btn avitar-btn--xs {{if (eq this.groupBy 'lastname') 'avitar-btn--primary' 'avitar-btn--ghost'}}"
                  {{on "click" (fn this.setGroupBy "lastname")}}
                >
                  Owner
                </button>
              </div>
            {{/if}}
          </div>

          {{! Search Input (works for both modes) }}
          <div class="avitar-mb-6">
            <input
              type="text"
              class="avitar-input"
              placeholder="{{if (eq this.viewMode 'tree') 'Filter properties...' 'Enter address or PID to search...'}}"
              value={{this.propertySearchText}}
              {{on "input" this.updatePropertySearch}}
            />
            {{#if (and this.searchingProperties (eq this.viewMode "list"))}}
              <div class="avitar-text-sm avitar-text-muted avitar-mt-2">
                <i class="fas fa-spinner fa-spin avitar-mr-2"></i>
                Searching...
              </div>
            {{/if}}
          </div>

          {{! Selected Property }}
          {{#if this.selectedProperty}}
            <div class="avitar-card avitar-ring-2 avitar-ring-success avitar-mb-4">
              <div class="avitar-card__body avitar-p-4">
                <div class="avitar-flex avitar-justify-between avitar-items-start">
                  <div class="avitar-flex-1">
                    <span class="avitar-badge avitar-badge--success avitar-mb-2">
                      <i class="fas fa-check avitar-mr-1"></i>
                      Selected Property
                    </span>
                    <h3 class="avitar-font-semibold avitar-text-gray-900 avitar-mb-2">
                      {{this.selectedProperty.pidFormatted}}
                    </h3>
                    <p class="avitar-text-sm avitar-text-gray-700 avitar-mb-1">
                      <i class="fas fa-map-marker-alt avitar-mr-1 avitar-text-muted"></i>
                      {{this.selectedProperty.address}}
                    </p>
                    {{#if this.selectedProperty.owner.primary_name}}
                      <p class="avitar-text-xs avitar-text-muted">
                        <i class="fas fa-user avitar-mr-1"></i>
                        Owner: {{this.selectedProperty.owner.primary_name}}
                      </p>
                    {{/if}}
                  </div>
                  <button
                    type="button"
                    class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary"
                    {{on "click" (fn this.selectProperty null)}}
                  >
                    Change
                  </button>
                </div>
              </div>
            </div>
          {{/if}}

          {{! List View - Search Results }}
          {{#if (eq this.viewMode "list")}}
            {{#if this.properties.length}}
              <div class="avitar-space-y-2">
                <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-3">
                  Search Results ({{this.properties.length}})
                </h3>
                {{#each this.properties as |property|}}
                  <div
                    class="avitar-card avitar-card--hover avitar-cursor-pointer"
                    {{on "click" (fn this.selectProperty property)}}
                  >
                    <div class="avitar-card__body avitar-p-4">
                      <div class="avitar-flex avitar-items-start avitar-gap-3">
                        <div class="avitar-flex-shrink-0">
                          <div
                            class="avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary-light avitar-text-primary avitar-flex avitar-items-center avitar-justify-center"
                          >
                            <i class="fas fa-home"></i>
                          </div>
                        </div>
                        <div class="avitar-flex-1">
                          <div class="avitar-flex avitar-items-start avitar-justify-between avitar-mb-2">
                            <div>
                              <div class="avitar-font-semibold avitar-text-gray-900 avitar-mb-1">
                                {{property.pidFormatted}}
                              </div>
                              <div class="avitar-text-sm avitar-text-gray-700">
                                <i class="fas fa-map-marker-alt avitar-mr-1 avitar-text-muted"></i>
                                {{property.address}}
                              </div>
                            </div>
                          </div>
                          {{#if property.owner.primary_name}}
                            <div class="avitar-text-xs avitar-text-muted avitar-mt-1">
                              <i class="fas fa-user avitar-mr-1"></i>
                              Owner: {{property.owner.primary_name}}
                            </div>
                          {{/if}}
                        </div>
                        <div class="avitar-flex-shrink-0">
                          <i class="fas fa-chevron-right avitar-text-gray-400"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                {{/each}}
              </div>
            {{else if this.propertySearchText}}
              <div class="avitar-empty-state avitar-py-8">
                <i class="fas fa-search fa-3x avitar-text-muted avitar-mb-4"></i>
                <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
                  No properties found
                </h3>
                <p class="avitar-text-muted">
                  Try searching with a different address or PID
                </p>
              </div>
            {{/if}}
          {{/if}}

          {{! Tree View - Grouped Properties }}
          {{#if (eq this.viewMode "tree")}}
            {{#if this.searchingProperties}}
              <div class="avitar-empty-state avitar-py-8">
                <i class="fas fa-spinner fa-spin fa-3x avitar-text-primary avitar-mb-4"></i>
                <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
                  Loading properties...
                </h3>
                <p class="avitar-text-muted">
                  Please wait while we load all properties for this municipality
                </p>
              </div>
            {{else if this.hasGroupedProperties}}
              <div class="avitar-space-y-2" style="max-height: 500px; overflow-y: auto;">
                {{#each-in this.filteredGroupedProperties as |groupKey properties|}}
                  <Assessing::PropertyTreeGroup
                    @groupBy={{this.groupBy}}
                    @groupKey={{groupKey}}
                    @properties={{properties}}
                    @selectedPropertyId={{this.selectedProperty.id}}
                    @onSelectProperty={{this.selectProperty}}
                    @getDisplayName={{this.getPropertyDisplayName}}
                    @getSecondaryInfo={{this.getPropertySecondaryInfo}}
                  />
                {{/each-in}}
              </div>
            {{else}}
              <div class="avitar-empty-state avitar-py-8">
                <i class="fas fa-home fa-3x avitar-text-muted avitar-mb-4"></i>
                <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
                  {{#if this.propertySearchText}}
                    No properties match your search
                  {{else}}
                    No properties available
                  {{/if}}
                </h3>
                <p class="avitar-text-muted">
                  {{#if this.propertySearchText}}
                    Try adjusting your filter
                  {{else}}
                    Properties will appear here once loaded
                  {{/if}}
                </p>
              </div>
            {{/if}}
          {{/if}}

          {{! Project Selection (shown after property is selected) }}
          {{#if this.selectedProperty}}
            <div class="avitar-mt-6 avitar-pt-6 avitar-border-t avitar-border-gray-200">
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-3">
                Permit or Project?
              </h3>
              <p class="avitar-text-sm avitar-text-muted avitar-mb-4">
                Choose whether this is a standalone permit or part of a larger project
              </p>

              {{! Mode Selection }}
              <div class="avitar-grid avitar-grid-cols-1 md:avitar-grid-cols-3 avitar-gap-3 avitar-mb-4">
                <button
                  type="button"
                  class="avitar-card avitar-card--hover {{if (eq this.permitMode 'standalone') 'avitar-ring-2 avitar-ring-primary avitar-bg-primary-light'}}"
                  {{on "click" (fn this.setPermitMode "standalone")}}
                >
                  <div class="avitar-card__body avitar-p-4 avitar-text-center">
                    <i class="fas fa-file-alt avitar-text-2xl avitar-mb-2 {{if (eq this.permitMode 'standalone') 'avitar-text-primary' 'avitar-text-muted'}}"></i>
                    <h4 class="avitar-font-semibold avitar-text-sm avitar-mb-1">Standalone Permit</h4>
                    <p class="avitar-text-xs avitar-text-muted">Single permit application</p>
                  </div>
                </button>

                <button
                  type="button"
                  class="avitar-card avitar-card--hover {{if (eq this.permitMode 'add-to-project') 'avitar-ring-2 avitar-ring-primary avitar-bg-primary-light'}}"
                  {{on "click" (fn this.setPermitMode "add-to-project")}}
                  disabled={{eq this.existingProjects.length 0}}
                >
                  <div class="avitar-card__body avitar-p-4 avitar-text-center">
                    <i class="fas fa-folder-plus avitar-text-2xl avitar-mb-2 {{if (eq this.permitMode 'add-to-project') 'avitar-text-primary' 'avitar-text-muted'}}"></i>
                    <h4 class="avitar-font-semibold avitar-text-sm avitar-mb-1">Add to Existing Project</h4>
                    <p class="avitar-text-xs avitar-text-muted">
                      {{#if this.existingProjects.length}}
                        {{this.existingProjects.length}} project(s) available
                      {{else}}
                        No existing projects
                      {{/if}}
                    </p>
                  </div>
                </button>

                <button
                  type="button"
                  class="avitar-card avitar-card--hover {{if (eq this.permitMode 'create-project') 'avitar-ring-2 avitar-ring-primary avitar-bg-primary-light'}}"
                  {{on "click" (fn this.setPermitMode "create-project")}}
                >
                  <div class="avitar-card__body avitar-p-4 avitar-text-center">
                    <i class="fas fa-folder-open avitar-text-2xl avitar-mb-2 {{if (eq this.permitMode 'create-project') 'avitar-text-primary' 'avitar-text-muted'}}"></i>
                    <h4 class="avitar-font-semibold avitar-text-sm avitar-mb-1">Create New Project</h4>
                    <p class="avitar-text-xs avitar-text-muted">Group multiple permits</p>
                  </div>
                </button>
              </div>

              {{! Add to Existing Project }}
              {{#if (eq this.permitMode "add-to-project")}}
                <div class="avitar-card avitar-bg-gray-50">
                  <div class="avitar-card__body avitar-p-4">
                    <label class="avitar-label avitar-mb-2">Select Existing Project</label>
                    <div class="avitar-space-y-2">
                      {{#each this.existingProjects as |project|}}
                        <button
                          type="button"
                          class="avitar-card avitar-card--hover avitar-w-full avitar-text-left {{if (eq this.selectedProject._id project._id) 'avitar-ring-2 avitar-ring-primary avitar-bg-primary-light'}}"
                          {{on "click" (fn this.selectExistingProject project)}}
                        >
                          <div class="avitar-card__body avitar-p-3">
                            <div class="avitar-flex avitar-items-center avitar-gap-3">
                              <i class="fas fa-folder avitar-text-primary"></i>
                              <div class="avitar-flex-1">
                                <p class="avitar-font-semibold avitar-text-sm">{{project.projectName}}</p>
                                <p class="avitar-text-xs avitar-text-muted">
                                  {{project.permitNumber}} â€¢ {{project.childPermits.length}} permits
                                </p>
                              </div>
                              {{#if (eq this.selectedProject._id project._id)}}
                                <i class="fas fa-check-circle avitar-text-primary"></i>
                              {{/if}}
                            </div>
                          </div>
                        </button>
                      {{/each}}
                    </div>
                  </div>
                </div>
              {{/if}}

              {{! Create New Project }}
              {{#if (eq this.permitMode "create-project")}}
                <div class="avitar-card avitar-bg-gray-50">
                  <div class="avitar-card__body avitar-p-4">
                    <h4 class="avitar-font-semibold avitar-mb-3">New Project Details</h4>

                    {{! Project Type Selection }}
                    <div class="avitar-mb-4">
                      <label class="avitar-label avitar-mb-2">Project Type</label>
                      <div class="avitar-grid avitar-grid-cols-2 avitar-gap-2">
                        {{#each this.projectTypes as |projectType|}}
                          <button
                            type="button"
                            class="avitar-card avitar-card--hover avitar-text-left {{if (eq this.selectedProjectType._id projectType._id) 'avitar-ring-2 avitar-ring-primary avitar-bg-primary-light'}}"
                            {{on "click" (fn this.selectProjectType projectType)}}
                          >
                            <div class="avitar-card__body avitar-p-3">
                              <div class="avitar-flex avitar-items-center avitar-gap-2">
                                <i class="fas fa-{{projectType.icon}} avitar-text-primary"></i>
                                <div class="avitar-flex-1 avitar-min-w-0">
                                  <h5 class="avitar-font-semibold avitar-text-sm avitar-truncate">{{projectType.name}}</h5>
                                  <p class="avitar-text-xs avitar-text-muted avitar-truncate">{{projectType.category}}</p>
                                </div>
                              </div>
                            </div>
                          </button>
                        {{/each}}
                      </div>
                    </div>

                    {{#if this.selectedProjectType}}
                      {{! Project Name }}
                      <div class="avitar-mb-4">
                        <label class="avitar-label">Project Name</label>
                        <input
                          type="text"
                          class="avitar-input"
                          placeholder="e.g., New Home Construction - 123 Main St"
                          value={{this.projectData.name}}
                          {{on "input" (fn this.updateProjectField "name")}}
                        />
                      </div>

                      {{! Project Description }}
                      <div class="avitar-mb-4">
                        <label class="avitar-label">Description (Optional)</label>
                        <textarea
                          class="avitar-input"
                          rows="2"
                          placeholder="Brief description of the project..."
                          value={{this.projectData.description}}
                          {{on "input" (fn this.updateProjectField "description")}}
                        ></textarea>
                      </div>

                      {{! Show default permits for this project type }}
                      {{#if this.selectedProjectType.defaultPermitTypes.length}}
                        <div class="avitar-p-3 avitar-bg-info-light avitar-rounded avitar-border avitar-border-info">
                          <p class="avitar-text-xs avitar-font-semibold avitar-text-info avitar-mb-2">
                            <i class="fas fa-info-circle avitar-mr-1"></i>
                            This project typically includes:
                          </p>
                          <ul class="avitar-list-disc avitar-list-inside avitar-text-xs avitar-text-gray-700">
                            {{#each this.selectedProjectType.defaultPermitTypes as |defaultPermit|}}
                              <li>{{defaultPermit.permitTypeId.name}}</li>
                            {{/each}}
                          </ul>
                          <p class="avitar-text-xs avitar-text-muted avitar-mt-2">
                            You'll be able to add these permits after creating the project
                          </p>
                        </div>
                      {{/if}}
                    {{/if}}
                  </div>
                </div>
              {{/if}}
            </div>
          {{/if}}
        </div>
      {{/if}}

      {{! Step 3: Permit Type Selection }}
      {{#if (eq this.currentStep 3)}}
        <div>
          <h2 class="avitar-text-xl avitar-font-semibold avitar-mb-4">
            Select Permit Type
          </h2>
          <p class="avitar-text-muted avitar-mb-6">
            Choose the type of permit you need
          </p>

          {{#if this.permitTypes.length}}
            <div class="avitar-grid avitar-grid-cols-1 md:avitar-grid-cols-2 avitar-gap-4">
              {{#each this.permitTypes as |permitType|}}
                <div
                  class="avitar-card avitar-card--hover avitar-cursor-pointer
                    {{if (and this.selectedPermitType (eq this.selectedPermitType.id permitType.id)) 'avitar-ring-2 avitar-ring-primary'}}"
                  {{on "click" (fn this.selectPermitType permitType)}}
                >
                  <div class="avitar-card__body avitar-p-4">
                    <div class="avitar-flex avitar-items-start avitar-gap-3">
                      <div class="avitar-flex-shrink-0">
                        <div
                          class="avitar-w-10 avitar-h-10 avitar-rounded-full avitar-bg-primary-light avitar-text-primary avitar-flex avitar-items-center avitar-justify-center"
                        >
                          <i class="fas fa-{{permitType.icon}}"></i>
                        </div>
                      </div>
                      <div class="avitar-flex-1">
                        <h3 class="avitar-font-semibold avitar-text-gray-900 avitar-mb-1">
                          {{permitType.name}}
                        </h3>
                        <p class="avitar-text-sm avitar-text-muted">
                          {{permitType.description}}
                        </p>
                        {{#if (and this.selectedPermitType (eq this.selectedPermitType.id permitType.id))}}
                          <span class="avitar-badge avitar-badge--success avitar-badge--sm avitar-mt-2">
                            <i class="fas fa-check avitar-mr-1"></i>
                            Selected
                          </span>
                        {{/if}}
                      </div>
                    </div>
                  </div>
                </div>
              {{/each}}
            </div>
          {{else}}
            <div class="avitar-empty-state avitar-py-8">
              <i class="fas fa-exclamation-circle fa-3x avitar-text-muted avitar-mb-4"></i>
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
                No Permit Types Available
              </h3>
              <p class="avitar-text-muted">
                Please contact the municipality to set up permit types.
              </p>
            </div>
          {{/if}}
        </div>
      {{/if}}

      {{! Step 4: Permit Details }}
      {{#if (eq this.currentStep 4)}}
        <div>
          <h2 class="avitar-text-xl avitar-font-semibold avitar-mb-4">
            Permit Details
          </h2>
          <p class="avitar-text-muted avitar-mb-6">
            Provide details about the work to be performed
          </p>

          <div class="avitar-space-y-4">
            {{! Description }}
            <div>
              <label class="avitar-label">
                Work Description
                <span class="avitar-text-danger">*</span>
              </label>
              <textarea
                class="avitar-input"
                rows="4"
                placeholder="Describe the work to be performed..."
                value={{this.permitData.description}}
                {{on "input" (fn this.updatePermitField "description")}}
              ></textarea>
            </div>

            {{! Scope of Work }}
            <div>
              <label class="avitar-label">Scope of Work (Optional)</label>
              <textarea
                class="avitar-input"
                rows="3"
                placeholder="Additional details about the scope..."
                value={{this.permitData.scopeOfWork}}
                {{on "input" (fn this.updatePermitField "scopeOfWork")}}
              ></textarea>
            </div>

            {{! Estimated Value and Square Footage }}
            <div class="avitar-grid avitar-grid-cols-2 avitar-gap-4">
              <div>
                <label class="avitar-label">
                  Estimated Value ($)
                  <span class="avitar-text-danger">*</span>
                </label>
                <input
                  type="number"
                  class="avitar-input"
                  placeholder="0.00"
                  min="0"
                  step="0.01"
                  value={{this.permitData.estimatedValue}}
                  {{on "input" (fn this.updatePermitField "estimatedValue")}}
                />
              </div>

              <div>
                <label class="avitar-label">Square Footage (Optional)</label>
                <input
                  type="number"
                  class="avitar-input"
                  placeholder="0"
                  min="0"
                  value={{this.permitData.squareFootage}}
                  {{on "input" (fn this.updatePermitField "squareFootage")}}
                />
              </div>
            </div>

            {{! Custom Form Fields from Permit Type }}
            {{#if this.selectedPermitType.customFormFields.length}}
              <div class="avitar-mt-6">
                <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-4">
                  {{this.selectedPermitType.name}} - Specific Information
                </h3>

                <div class="avitar-space-y-4">
                  {{#each this.selectedPermitType.customFormFields as |field|}}
                    <div>
                      <label class="avitar-label">
                        {{field.label}}
                        {{#if field.required}}
                          <span class="avitar-text-danger">*</span>
                        {{/if}}
                      </label>

                      {{#if (eq field.type "text")}}
                        <input
                          type="text"
                          class="avitar-input"
                          placeholder={{field.placeholder}}
                          required={{field.required}}
                          value={{get this.permitData.customFields field.id}}
                          {{on "input" (fn this.updateCustomField field.id)}}
                        />
                      {{else if (eq field.type "textarea")}}
                        <textarea
                          class="avitar-input"
                          rows="3"
                          placeholder={{field.placeholder}}
                          required={{field.required}}
                          {{on "input" (fn this.updateCustomField field.id)}}
                        >{{get this.permitData.customFields field.id}}</textarea>
                      {{else if (eq field.type "number")}}
                        <input
                          type="number"
                          class="avitar-input"
                          placeholder={{field.placeholder}}
                          required={{field.required}}
                          value={{get this.permitData.customFields field.id}}
                          {{on "input" (fn this.updateCustomField field.id)}}
                        />
                      {{else if (eq field.type "currency")}}
                        <div class="avitar-input-group">
                          <span class="avitar-input-group__addon">$</span>
                          <input
                            type="number"
                            class="avitar-input"
                            placeholder={{field.placeholder}}
                            required={{field.required}}
                            step="0.01"
                            min="0"
                            value={{get this.permitData.customFields field.id}}
                            {{on "input" (fn this.updateCustomField field.id)}}
                          />
                        </div>
                      {{else if (eq field.type "date")}}
                        <input
                          type="date"
                          class="avitar-input"
                          required={{field.required}}
                          value={{get this.permitData.customFields field.id}}
                          {{on "input" (fn this.updateCustomField field.id)}}
                        />
                      {{else if (eq field.type "select")}}
                        <select
                          class="avitar-select"
                          required={{field.required}}
                          {{on "change" (fn this.updateCustomField field.id)}}
                        >
                          <option value="">-- Select {{field.label}} --</option>
                          {{#each field.options as |fieldOption|}}
                            <option
                              value={{fieldOption}}
                              selected={{eq (get this.permitData.customFields field.id) fieldOption}}
                            >
                              {{fieldOption}}
                            </option>
                          {{/each}}
                        </select>
                      {{else if (eq field.type "checkbox")}}
                        <div class="avitar-space-y-2">
                          {{#each field.options as |fieldOption|}}
                            <label class="avitar-flex avitar-items-center avitar-gap-2">
                              <input
                                type="checkbox"
                                class="avitar-checkbox"
                                value={{fieldOption}}
                                checked={{includes (get this.permitData.customFields field.id) fieldOption}}
                                {{on "change" (fn this.updateCustomFieldCheckbox field.id fieldOption)}}
                              />
                              <span>{{fieldOption}}</span>
                            </label>
                          {{/each}}
                        </div>
                      {{/if}}

                      {{#if field.helpText}}
                        <p class="avitar-text-xs avitar-text-muted avitar-mt-1">
                          {{field.helpText}}
                        </p>
                      {{/if}}
                    </div>
                  {{/each}}
                </div>
              </div>
            {{/if}}

            {{! Applicant Information }}
            <div class="avitar-mt-6">
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-4">
                Applicant Information
              </h3>

              <div class="avitar-grid avitar-grid-cols-2 avitar-gap-4">
                <div>
                  <label class="avitar-label">Name</label>
                  <input
                    type="text"
                    class="avitar-input"
                    value={{this.permitData.applicant.name}}
                    {{on "input" (fn this.updateApplicantField "name")}}
                  />
                </div>

                <div>
                  <label class="avitar-label">Email</label>
                  <input
                    type="email"
                    class="avitar-input"
                    value={{this.permitData.applicant.email}}
                    {{on "input" (fn this.updateApplicantField "email")}}
                  />
                </div>

                <div>
                  <label class="avitar-label">Phone</label>
                  <input
                    type="tel"
                    class="avitar-input"
                    value={{this.permitData.applicant.phone}}
                    {{on "input" (fn this.updateApplicantField "phone")}}
                  />
                </div>
              </div>
            </div>

            {{! Document Attachments }}
            <div class="avitar-mt-6">
              <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-4">
                Documents (Optional)
              </h3>
              <p class="avitar-text-sm avitar-text-muted avitar-mb-4">
                Attach supporting documents for your permit application
              </p>

              {{! Action Buttons }}
              <div class="avitar-flex avitar-gap-3 avitar-mb-4">
                <label class="avitar-btn avitar-btn--secondary avitar-btn--sm">
                  <i class="fas fa-upload avitar-mr-2"></i>
                  Upload New Files
                  <input
                    type="file"
                    multiple
                    class="avitar-hidden"
                    {{on "change" this.handleFileUpload}}
                  />
                </label>

                {{#if @model.isContractor}}
                  <button
                    type="button"
                    class="avitar-btn avitar-btn--primary avitar-btn--sm"
                    {{on "click" this.openContractorLibrary}}
                  >
                    <i class="fas fa-briefcase avitar-mr-2"></i>
                    My Company Library
                  </button>
                {{/if}}

                <button
                  type="button"
                  class="avitar-btn avitar-btn--success avitar-btn--sm"
                  {{on "click" this.openDocumentLibrary}}
                >
                  <i class="fas fa-building avitar-mr-2"></i>
                  Town Library
                </button>
              </div>

              {{! Attached Documents from Town Library }}
              {{#if this.attachedDocuments.length}}
                <div class="avitar-mb-4">
                  <h4 class="avitar-text-sm avitar-font-semibold avitar-mb-2">
                    From Town Library ({{this.attachedDocuments.length}})
                  </h4>
                  <div class="avitar-space-y-2">
                    {{#each this.attachedDocuments as |doc|}}
                      <div class="avitar-flex avitar-items-center avitar-gap-3 avitar-p-3 avitar-rounded avitar-border avitar-border-success avitar-bg-success-light">
                        <div class="avitar-flex-shrink-0">
                          <i class="fas fa-building avitar-text-success"></i>
                        </div>
                        <div class="avitar-flex-1 avitar-min-w-0">
                          <div class="avitar-font-medium avitar-truncate">
                            {{doc.displayName}}
                          </div>
                          <div class="avitar-text-xs avitar-text-muted">
                            From town document library
                          </div>
                        </div>
                        <button
                          type="button"
                          class="avitar-btn avitar-btn--ghost avitar-btn--xs"
                          {{on "click" (fn this.removeAttachedDocument doc)}}
                          title="Remove"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    {{/each}}
                  </div>
                </div>
              {{/if}}

              {{! Attached Documents from Contractor Library }}
              {{#if this.contractorDocuments.length}}
                <div class="avitar-mb-4">
                  <h4 class="avitar-text-sm avitar-font-semibold avitar-mb-2">
                    From My Company Library ({{this.contractorDocuments.length}})
                  </h4>
                  <div class="avitar-space-y-2">
                    {{#each this.contractorDocuments as |doc|}}
                      <div class="avitar-flex avitar-items-center avitar-gap-3 avitar-p-3 avitar-rounded avitar-border avitar-border-primary avitar-bg-primary-light">
                        <div class="avitar-flex-shrink-0">
                          <i class="fas fa-briefcase avitar-text-primary"></i>
                        </div>
                        <div class="avitar-flex-1 avitar-min-w-0">
                          <div class="avitar-font-medium avitar-truncate">
                            {{doc.displayName}}
                          </div>
                          <div class="avitar-text-xs avitar-text-muted">
                            From your company document library
                          </div>
                        </div>
                        <button
                          type="button"
                          class="avitar-btn avitar-btn--ghost avitar-btn--xs"
                          {{on "click" (fn this.removeContractorDocument doc)}}
                          title="Remove"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    {{/each}}
                  </div>
                </div>
              {{/if}}

              {{! Uploaded Files }}
              {{#if this.uploadedFiles.length}}
                <div class="avitar-mb-4">
                  <h4 class="avitar-text-sm avitar-font-semibold avitar-mb-2">
                    Uploaded Files ({{this.uploadedFiles.length}})
                  </h4>
                  <div class="avitar-space-y-2">
                    {{#each this.uploadedFiles as |file|}}
                      <div class="avitar-flex avitar-items-center avitar-gap-3 avitar-p-3 avitar-rounded avitar-border avitar-border-primary avitar-bg-primary-light">
                        <div class="avitar-flex-shrink-0">
                          <i class="fas fa-file avitar-text-primary"></i>
                        </div>
                        <div class="avitar-flex-1 avitar-min-w-0">
                          <div class="avitar-font-medium avitar-truncate">
                            {{file.displayName}}
                          </div>
                          <div class="avitar-text-xs avitar-text-muted">
                            Newly uploaded
                          </div>
                        </div>
                        <button
                          type="button"
                          class="avitar-btn avitar-btn--ghost avitar-btn--xs"
                          {{on "click" (fn this.removeUploadedFile file)}}
                          title="Remove"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    {{/each}}
                  </div>
                </div>
              {{/if}}

              {{! Empty State }}
              {{#unless (or this.attachedDocuments.length this.contractorDocuments.length this.uploadedFiles.length)}}
                <div class="avitar-card avitar-bg-gray-50 avitar-border-dashed">
                  <div class="avitar-card__body avitar-text-center avitar-py-6">
                    <i class="fas fa-file-upload fa-2x avitar-text-muted avitar-mb-3"></i>
                    <p class="avitar-text-sm avitar-text-muted">
                      No documents attached yet
                    </p>
                    <p class="avitar-text-xs avitar-text-muted avitar-mt-1">
                      {{#if @model.isContractor}}
                        Upload new files, browse your company library, or browse the town library
                      {{else}}
                        Upload new files or browse the town document library
                      {{/if}}
                    </p>
                  </div>
                </div>
              {{/unless}}
            </div>
          </div>
        </div>
      {{/if}}

      {{! Step 5: Review and Submit }}
      {{#if (eq this.currentStep 5)}}
        <div>
          <h2 class="avitar-text-xl avitar-font-semibold avitar-mb-4">
            Review Application
          </h2>
          <p class="avitar-text-muted avitar-mb-6">
            Please review your permit application before submitting
          </p>

          <div class="avitar-space-y-6">
            {{! Municipality }}
            <div>
              <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                Municipality
              </h3>
              <div class="avitar-card avitar-bg-gray-50">
                <div class="avitar-card__body avitar-p-4">
                  <div class="avitar-flex avitar-items-center avitar-gap-3">
                    <i class="fas fa-map-marker-alt avitar-text-primary"></i>
                    <span class="avitar-font-medium">{{this.selectedMunicipality.name}}</span>
                  </div>
                </div>
              </div>
            </div>

            {{! Property }}
            <div>
              <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                Property
              </h3>
              <div class="avitar-card avitar-bg-gray-50">
                <div class="avitar-card__body avitar-p-4">
                  <div class="avitar-font-medium">{{this.selectedProperty.pidFormatted}}</div>
                  <div class="avitar-text-sm avitar-text-muted">
                    {{this.selectedProperty.address}}
                  </div>
                </div>
              </div>
            </div>

            {{! Permit Type }}
            <div>
              <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                Permit Type
              </h3>
              <div class="avitar-card avitar-bg-gray-50">
                <div class="avitar-card__body avitar-p-4">
                  <div class="avitar-font-medium">{{this.selectedPermitType.name}}</div>
                  <div class="avitar-text-sm avitar-text-muted">
                    {{this.selectedPermitType.description}}
                  </div>
                </div>
              </div>
            </div>

            {{! Work Details }}
            <div>
              <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                Work Description
              </h3>
              <div class="avitar-card avitar-bg-gray-50">
                <div class="avitar-card__body avitar-p-4">
                  {{log "ðŸŽ¨ Review page rendering - description:" this.permitData.description}}
                  {{log "ðŸŽ¨ Review page rendering - estimatedValue:" this.permitData.estimatedValue}}
                  {{log "ðŸŽ¨ Review page rendering - squareFootage:" this.permitData.squareFootage}}
                  {{log "ðŸŽ¨ Review page rendering - customFields:" this.permitData.customFields}}

                  <p>{{this.permitData.description}}</p>
                  {{#if this.permitData.scopeOfWork}}
                    <p class="avitar-mt-2 avitar-text-sm avitar-text-muted">
                      {{this.permitData.scopeOfWork}}
                    </p>
                  {{/if}}
                  <div class="avitar-flex avitar-gap-6 avitar-mt-4">
                    <div>
                      <span class="avitar-text-sm avitar-text-muted">Estimated Value:</span>
                      <span class="avitar-font-medium avitar-ml-2">
                        ${{this.permitData.estimatedValue}}
                      </span>
                    </div>
                    {{#if this.permitData.squareFootage}}
                      <div>
                        <span class="avitar-text-sm avitar-text-muted">Square Footage:</span>
                        <span class="avitar-font-medium avitar-ml-2">
                          {{this.permitData.squareFootage}}
                          sq ft
                        </span>
                      </div>
                    {{/if}}
                  </div>
                </div>
              </div>
            </div>

            {{! Custom Form Fields }}
            {{#if this.selectedPermitType.customFormFields.length}}
              <div>
                <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                  {{this.selectedPermitType.name}} - Specific Information
                </h3>
                <div class="avitar-card avitar-bg-gray-50">
                  <div class="avitar-card__body avitar-p-4">
                    <div class="avitar-space-y-3">
                      {{#each this.selectedPermitType.customFormFields as |field|}}
                        <div>
                          <span class="avitar-text-sm avitar-font-medium avitar-text-gray-700">
                            {{field.label}}:
                          </span>
                          <div class="avitar-mt-1">
                            {{#if (eq field.type "checkbox")}}
                              {{#if (get this.permitData.customFields field.id)}}
                                <ul class="avitar-list-disc avitar-list-inside avitar-text-sm">
                                  {{#each (get this.permitData.customFields field.id) as |selectedOption|}}
                                    <li>{{selectedOption}}</li>
                                  {{/each}}
                                </ul>
                              {{else}}
                                <span class="avitar-text-muted avitar-text-sm">None selected</span>
                              {{/if}}
                            {{else if (eq field.type "currency")}}
                              <span class="avitar-font-medium">
                                ${{get this.permitData.customFields field.id}}
                              </span>
                            {{else}}
                              <span class="avitar-font-medium">
                                {{get this.permitData.customFields field.id}}
                              </span>
                            {{/if}}
                          </div>
                        </div>
                      {{/each}}
                    </div>
                  </div>
                </div>
              </div>
            {{/if}}

            {{! Applicant Information }}
            <div>
              <h3 class="avitar-text-sm avitar-font-medium avitar-text-gray-700 avitar-mb-2">
                Applicant Information
              </h3>
              <div class="avitar-card avitar-bg-gray-50">
                <div class="avitar-card__body avitar-p-4">
                  <div class="avitar-grid avitar-grid-cols-2 avitar-gap-4">
                    <div>
                      <span class="avitar-text-sm avitar-text-muted">Name:</span>
                      <span class="avitar-font-medium avitar-ml-2">
                        {{this.permitData.applicant.name}}
                      </span>
                    </div>
                    <div>
                      <span class="avitar-text-sm avitar-text-muted">Email:</span>
                      <span class="avitar-font-medium avitar-ml-2">
                        {{this.permitData.applicant.email}}
                      </span>
                    </div>
                    <div>
                      <span class="avitar-text-sm avitar-text-muted">Phone:</span>
                      <span class="avitar-font-medium avitar-ml-2">
                        {{this.permitData.applicant.phone}}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {{/if}}
    </div>

    {{! Wizard Navigation }}
    <div>
      <div class="avitar-card__footer avitar-bg-gray-50 avitar-flex avitar-justify-between avitar-p-4">
        <div>
          {{#if this.canGoPrevious}}
            <button
              type="button"
              class="avitar-btn avitar-btn--secondary"
              {{on "click" this.previousStep}}
              disabled={{this.isLoading}}
            >
              <i class="fas fa-arrow-left avitar-mr-2"></i>
              Previous
            </button>
          {{/if}}
        </div>

        <div class="avitar-flex avitar-gap-3">
          {{#if (eq this.currentStep 5)}}
            <button
              type="button"
              class="avitar-btn avitar-btn--secondary"
              {{on "click" this.saveDraft}}
              disabled={{this.isLoading}}
            >
              <i class="fas fa-save avitar-mr-2"></i>
              Save Draft
            </button>

            <button
              type="button"
              class="avitar-btn avitar-btn--primary"
              {{on "click" this.submitPermit}}
              disabled={{this.isLoading}}
            >
              {{#if this.isLoading}}
                <i class="fas fa-spinner fa-spin avitar-mr-2"></i>
                Preparing Payment...
              {{else}}
                <i class="fas fa-arrow-right avitar-mr-2"></i>
                Continue to Payment
              {{/if}}
            </button>
          {{else}}
            <button
              type="button"
              class="avitar-btn avitar-btn--primary"
              {{on "click" this.nextStep}}
              disabled={{not this.canGoNext}}
            >
              Next
              <i class="fas fa-arrow-right avitar-ml-2"></i>
            </button>
          {{/if}}
        </div>
      </div>
    </div>
  </div>

  {{! Document Library Modal }}
  {{#if this.showDocumentLibraryModal}}
    <div
      class="avitar-modal-overlay avitar-modal-overlay--visible"
      {{on "click" this.closeDocumentLibrary}}
    >
      <div
        class="avitar-modal avitar-modal--lg"
        style="max-width: 90vw;"
        {{on "click" this.stopPropagation}}
        role="dialog"
        aria-modal="true"
      >
        <div class="avitar-modal__header">
          <h2 class="avitar-modal__title">
            <i class="fas fa-folder-open avitar-mr-2"></i>
            Town Document Library
          </h2>
          <button
            type="button"
            class="avitar-modal__close"
            {{on "click" this.closeDocumentLibrary}}
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="avitar-modal__body">
          <div class="avitar-card avitar-bg-info-light avitar-border-info avitar-mb-4">
            <div class="avitar-card__body avitar-p-3">
              <div class="avitar-flex avitar-items-start avitar-gap-2">
                <i class="fas fa-info-circle avitar-text-info"></i>
                <div class="avitar-text-sm">
                  <strong>Tip:</strong>
                  Select documents from the town library to attach to your permit. These documents are stored once and can be reused across multiple permits.
                </div>
              </div>
            </div>
          </div>

          {{#if this.selectedMunicipality}}
            <Shared::FileBrowser
              @municipalityId={{this.selectedMunicipality.id}}
              @department="building_permit"
              @selectionMode="multiple"
              @onSelect={{this.handleDocumentSelection}}
            />
          {{else}}
            <div class="avitar-empty-state avitar-py-8">
              <i class="fas fa-exclamation-circle fa-3x avitar-text-muted avitar-mb-4"></i>
              <p class="avitar-text-muted">
                Please select a municipality first
              </p>
            </div>
          {{/if}}
        </div>

        <div class="avitar-modal__footer">
          <button
            type="button"
            class="avitar-btn avitar-btn--primary"
            {{on "click" this.closeDocumentLibrary}}
          >
            <i class="fas fa-check avitar-mr-2"></i>
            Done
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  {{! Contractor Document Library Modal }}
  {{#if this.showContractorLibraryModal}}
    <div
      class="avitar-modal-overlay avitar-modal-overlay--visible"
      {{on "click" this.closeContractorLibrary}}
    >
      <div
        class="avitar-modal avitar-modal--lg"
        style="max-width: 90vw;"
        {{on "click" this.stopPropagation}}
        role="dialog"
        aria-modal="true"
      >
        <div class="avitar-modal__header">
          <h2 class="avitar-modal__title">
            <i class="fas fa-briefcase avitar-mr-2"></i>
            My Company Document Library
          </h2>
          <button
            type="button"
            class="avitar-modal__close"
            {{on "click" this.closeContractorLibrary}}
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="avitar-modal__body">
          <div class="avitar-card avitar-bg-info-light avitar-border-info avitar-mb-4">
            <div class="avitar-card__body avitar-p-3">
              <div class="avitar-flex avitar-items-start avitar-gap-2">
                <i class="fas fa-info-circle avitar-text-info"></i>
                <div class="avitar-text-sm">
                  <strong>Tip:</strong>
                  Select documents from your company library to attach to this permit. These are your private company documents.
                </div>
              </div>
            </div>
          </div>

          {{#if this.currentUser.user.contractor_id}}
            <Shared::FileBrowser
              @contractorId={{this.currentUser.user.contractor_id}}
              @department="contractor"
              @selectionMode="multiple"
              @onSelect={{this.handleContractorDocumentSelection}}
            />
          {{else}}
            <div class="avitar-empty-state avitar-py-8">
              <i class="fas fa-exclamation-circle fa-3x avitar-text-muted avitar-mb-4"></i>
              <p class="avitar-text-muted">
                No contractor profile found
              </p>
            </div>
          {{/if}}
        </div>

        <div class="avitar-modal__footer">
          <button
            type="button"
            class="avitar-btn avitar-btn--primary"
            {{on "click" this.closeContractorLibrary}}
          >
            <i class="fas fa-check avitar-mr-2"></i>
            Done
          </button>
        </div>
      </div>
    </div>
  {{/if}}

  {{! Stripe Payment Modal }}
  <StripePaymentModal
    @isOpen={{this.showPaymentModal}}
    @title="Complete Permit Payment"
    @description={{concat "Pay permit fees to " this.selectedMunicipality.name}}
    @amount={{this.paymentBreakdown.totalAmount}}
    @paymentBreakdown={{this.paymentBreakdown}}
    @isPermitPayment={{true}}
    @clientSecret={{this.clientSecret}}
    @stripeAccountId={{this.stripeAccountId}}
    @billingEmail={{this.currentUser.user.email}}
    @billingName={{this.permitData.applicant.name}}
    @onSuccess={{this.handlePaymentSuccess}}
    @onClose={{this.closePaymentModal}}
  />
</div>

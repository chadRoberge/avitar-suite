{{!-- Waterfront Settings --}}
<div class="avitar-content">
  <div class="avitar-page-header avitar-flex avitar-items-center avitar-flex-row avitar-mb-2">
    <div class="avitar-flex-5">
      <h1 class="avitar-page-title avitar-skinny">Waterfront Settings</h1>
      <div class="avitar-page-subtitle">Configure waterfront properties and attributes</div>
    </div>
    <div class="avitar-flex-5 avitar-flex avitar-justify-end avitar-items-center avitar-gap-3">
      {{!-- Year Selector --}}
      <div class="avitar-flex avitar-items-center avitar-gap-2">
        <label class="avitar-text-sm avitar-font-medium">Config Year:</label>
        <select class="avitar-select avitar-select--sm" style="width: 100px;" {{on "change" this.changeYear}}>
          {{#each this.availableYears as |yearOption|}}
            <option value={{yearOption}} selected={{eq this.configYear yearOption}}>
              {{yearOption}}
            </option>
          {{/each}}
        </select>
        {{#if this.isYearLocked}}
          <span class="avitar-badge avitar-badge--warning avitar-ml-2">
            {{lnr-icon "lock" class="avitar-mr-1"}}
            Locked
          </span>
        {{/if}}
      </div>
      {{! Editor level (2) and above in Assessing module can add water bodies }}
      {{#if (has-module-role this.currentUser "assessing" 2)}}
        <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.openNewWaterBodyModal}} disabled={{this.isYearLocked}}>
          {{lnr-icon "plus-circle" class="avitar-mr-2"}}
          Add Water Body
        </button>
      {{/if}}
    </div>
  </div>

  {{!-- Year Locked Warning Banner --}}
  {{#if this.isYearLocked}}
    <div class="avitar-alert avitar-alert--warning avitar-mb-4">
      <div class="avitar-flex avitar-items-center avitar-gap-3">
        {{lnr-icon "lock" class="avitar-text-lg"}}
        <div>
          <strong>Configuration Locked</strong>
          <p class="avitar-text-sm avitar-mb-0">
            The configuration for year {{this.configYear}} is locked and cannot be modified.
            Select a different year to make changes.
          </p>
        </div>
      </div>
    </div>
  {{/if}}
  {{!-- Water Body Cards with Integrated Ladders --}}
  {{#each this.reactiveWaterBodies as |waterBody|}}
  {{#let (get this.laddersByWaterBody waterBody.stringId) as |ladder|}}
  <div class="avitar-card avitar-mb-6">
    <div class="avitar-card__header avitar-card__header--colored">
      <div class="avitar-flex avitar-justify-between avitar-items-center avitar-w-full">
        <div class="avitar-flex avitar-items-center avitar-gap-4">
          <div>
            <h3 class="avitar-card__title">
              <i class="fas fa-water avitar-mr-2"></i>
              <span class="avitar-badge avitar-badge--primary avitar-mr-2">{{waterBody.name}}</span>
            </h3>
            <div class="avitar-card__subtitle">
              {{waterBody.description}}
            </div>
            <div class="avitar-card__subtitle avitar-text-sm avitar-font-semibold avitar-text-success avitar-mt-1">
              Base Waterfront Value: ${{number-format waterBody.baseWaterValue}}
            </div>
            <div class="avitar-card__subtitle avitar-text-xs avitar-text-muted">
              {{capitalize waterBody.waterBodyType}} • Created {{date-format waterBody.createdAt}}
            </div>
          </div>
        </div>
        <div class="avitar-flex avitar-gap-2">
          {{! Editor level (2) and above in Assessing can edit }}
          {{#if (has-module-role this.currentUser "assessing" 2)}}
            <button type="button" class="avitar-btn avitar-btn--secondary avitar-btn--sm" {{on "click" (fn this.openEditWaterBodyModal waterBody)}}>
              <i class="fas fa-edit avitar-mr-1"></i>
              Edit Water Body
            </button>
          {{/if}}
          {{! Admin level (4) only in Assessing can delete }}
          {{#if (has-module-role this.currentUser "assessing" 4)}}
            <button type="button" class="avitar-btn avitar-btn--danger avitar-btn--sm" {{on "click" (fn this.deleteWaterBody (or waterBody.id waterBody._id))}}>
              <i class="fas fa-trash avitar-mr-1"></i>
              Delete
            </button>
          {{/if}}
        </div>
      </div>
    </div>
    <div class="avitar-card__body">
      {{#if ladder}}
      <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-4">
        <h4 class="avitar-font-semibold">Waterfront Valuation Ladder</h4>
        {{! Editor level (2) and above in Assessing can modify ladder }}
        {{#if (has-module-role this.currentUser "assessing" 2)}}
          <div class="avitar-flex avitar-gap-2">
            <button type="button" class="avitar-btn avitar-btn--primary avitar-btn--sm" {{on "click" (fn this.openNewLadderEntryModal waterBody)}}>
              <i class="fas fa-plus avitar-mr-1"></i>
              Add Entry
            </button>
            <button type="button" class="avitar-btn avitar-btn--outline avitar-btn--sm" {{on "click" (fn this.openWaterBodyLadderModal waterBody)}}>
              <i class="fas fa-edit avitar-mr-1"></i>
              Edit All
            </button>
          </div>
        {{/if}}
      </div>
      <div class="avitar-flex avitar-gap-6">
        {{!-- Water Body Ladder Table --}}
        <div class="avitar-flex-4">
          <div class="avitar-table-container">
            <table class="avitar-table avitar-table--compact">
              <thead>
                <tr>
                  <th>Frontage</th>
                  <th>Factor</th>
                  <th class="avitar-table__actions-col">Actions</th>
                </tr>
              </thead>
              <tbody>
                {{#each ladder.entries as |entry|}}
                <tr>
                  <td>
                    <span class="avitar-font-semibold">{{entry.frontage}} ft</span>
                  </td>
                  <td>
                    <span class="avitar-text-success avitar-font-semibold">
                      {{number-format entry.factor}}
                    </span>
                  </td>
                  <td class="avitar-table__actions">
                    {{! Editor level (2) and above in Assessing can edit }}
                    {{#if (has-module-role this.currentUser "assessing" 2)}}
                      <button type="button" class="avitar-btn avitar-btn--secondary avitar-btn--xs" {{on "click" (fn this.openLadderEntryModal waterBody entry)}} title="Edit Entry">
                        <i class="fas fa-edit"></i>
                      </button>
                    {{/if}}
                    {{! Reviewer level (3) and above in Assessing can delete }}
                    {{#if (has-module-role this.currentUser "assessing" 3)}}
                      <button type="button" class="avitar-btn avitar-btn--danger avitar-btn--xs" {{on "click" (fn this.deleteLadderEntry waterBody entry)}} title="Remove Entry">
                        <i class="fas fa-times"></i>
                      </button>
                    {{/if}}
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
          </div>
        </div>
        {{!-- Waterfront Factor Graph --}}
        <div class="avitar-flex-6">
          <div class="avitar-border avitar-rounded avitar-p-4">
            <h5 class="avitar-font-semibold avitar-mb-3">Waterfront Factor Curve</h5>
            <LineGraph
              @data={{ladder.entries}}
              @xField="frontage"
              @yField="factor"
              @xLabel="Frontage (ft)"
              @yLabel="Factor"
              @lineColor="#3b82f6"
              @title="Waterfront Factor Curve"
            />
          </div>
        </div>
      </div>
      {{else}}
      <div class="avitar-empty-state avitar-text-center avitar-py-6">
        <i class="fas fa-water avitar-text-3xl avitar-text-muted avitar-mb-3"></i>
        <div class="avitar-font-semibold avitar-mb-2">No Valuation Ladder</div>
        <div class="avitar-text-muted avitar-mb-4">
          {{#if (has-module-role this.currentUser "assessing" 2)}}
            Create a waterfront valuation ladder for this water body
          {{else}}
            Contact an Assessing editor to create a valuation ladder for this water body
          {{/if}}
        </div>
        {{! Editor level (2) and above in Assessing can create ladder }}
        {{#if (has-module-role this.currentUser "assessing" 2)}}
          <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" (fn this.openWaterBodyLadderModal waterBody)}}>
            <i class="fas fa-plus avitar-mr-2"></i>
            Create Valuation Ladder
          </button>
        {{/if}}
      </div>
      {{/if}}
    </div>
  </div>
  {{/let}}
  {{/each}}
  {{#unless this.reactiveWaterBodies.length}}
  <div class="avitar-empty-state avitar-text-center avitar-py-8">
    <i class="fas fa-water avitar-text-4xl avitar-text-muted avitar-mb-3"></i>
    <div class="avitar-text-xl avitar-font-semibold avitar-mb-2">No Water Bodies Configured</div>
    <div class="avitar-text-muted avitar-mb-4">
      {{#if (has-module-role this.currentUser "assessing" 2)}}
        Create your first water body to get started
      {{else}}
        Contact an Assessing editor to configure water bodies
      {{/if}}
    </div>
    {{! Editor level (2) and above in Assessing can create water bodies }}
    {{#if (has-module-role this.currentUser "assessing" 2)}}
      <div class="avitar-flex avitar-gap-2 avitar-justify-center">
        <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.openNewWaterBodyModal}}>
          <i class="fas fa-plus avitar-mr-2"></i>
          Create Water Body
        </button>
        <button type="button" class="avitar-btn avitar-btn--secondary" {{on "click" this.createWaterBodyDefaults}}>
          <i class="fas fa-magic avitar-mr-2"></i>
          Create Defaults
        </button>
      </div>
    {{/if}}
  </div>
  {{/unless}}
  {{!-- Waterfront Attributes Section --}}
  <div class="avitar-card avitar-mb-6">
    <div class="avitar-card__header avitar-card__header--colored">
      <div class="avitar-flex avitar-justify-between avitar-items-center">
        <div>
          <h3 class="avitar-card__title">Waterfront Attributes</h3>
          <div class="avitar-card__subtitle">Configure waterfront property valuation attributes</div>
        </div>
        {{! Editor level (2) and above in Assessing can create defaults }}
        {{#if (has-module-role this.currentUser "assessing" 2)}}
          <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.createAttributeDefaults}}>
            <i class="fas fa-plus avitar-mr-2"></i>
            Create Defaults
          </button>
        {{/if}}
      </div>
    </div>
    <div class="avitar-card__body">
      {{#each this.waterfrontAttributeTypes as |attributeType|}}
      <div class="avitar-border avitar-rounded avitar-p-4 avitar-mb-4">
        <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-4">
          <div>
            <h4 class="avitar-font-semibold avitar-flex avitar-items-center">
              <i class="{{attributeType.icon}} avitar-mr-2"></i>
              {{attributeType.title}}
            </h4>
            <div class="avitar-text-xs avitar-text-muted">{{attributeType.subtitle}}</div>
          </div>
          {{! Editor level (2) and above in Assessing can add attributes }}
          {{#if (has-module-role this.currentUser "assessing" 2)}}
            <button type="button" class="avitar-btn avitar-btn--primary avitar-btn--sm" {{on "click" (fn this.openNewAttributeModal attributeType.key)}}>
              <i class="fas fa-plus avitar-mr-1"></i>
              Add {{attributeType.title}}
            </button>
          {{/if}}
        </div>
        {{#let (get this.attributesByType attributeType.key) as |attributes|}}
        {{#if attributes.length}}
        <div class="avitar-table-container">
          <table class="avitar-table avitar-table--compact">
            <thead>
              <tr>
                <th>Name</th>
                <th>Display Text</th>
                <th>Factor</th>
                <th class="avitar-table__actions-col">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each attributes as |attribute|}}
              <tr>
                <td>
                  <div class="avitar-font-semibold">{{attribute.name}}</div>
                  <div class="avitar-text-xs avitar-text-muted">{{attribute.description}}</div>
                </td>
                <td>
                  <span class="avitar-badge avitar-badge--primary">{{attribute.displayText}}</span>
                </td>
                <td>
                  <span class="avitar-font-bold avitar-text-success">{{number-format attribute.factor}}</span>
                </td>
                <td class="avitar-table__actions">
                  {{! Editor level (2) and above in Assessing can edit }}
                  {{#if (has-module-role this.currentUser "assessing" 2)}}
                    <button type="button" class="avitar-btn avitar-btn--secondary avitar-btn--xs" {{on "click" (fn this.openEditAttributeModal attributeType.key attribute)}} title="Edit Attribute">
                      <i class="fas fa-edit"></i>
                    </button>
                  {{/if}}
                  {{! Admin level (4) only in Assessing can delete }}
                  {{#if (has-module-role this.currentUser "assessing" 4)}}
                    <button type="button" class="avitar-btn avitar-btn--danger avitar-btn--xs" {{on "click" (fn this.deleteAttribute attribute)}} title="Delete Attribute">
                      <i class="fas fa-trash"></i>
                    </button>
                  {{/if}}
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
        {{else}}
        <div class="avitar-empty-state avitar-text-center avitar-py-6">
          <i class="{{attributeType.icon}} avitar-text-2xl avitar-text-muted avitar-mb-2"></i>
          <div class="avitar-font-semibold avitar-mb-1">No {{attributeType.title}} Attributes</div>
          <div class="avitar-text-xs avitar-text-muted avitar-mb-3">
            {{#if (has-module-role this.currentUser "assessing" 2)}}
              Add different types of {{attributeType.title}} attributes
            {{else}}
              Contact an Assessing editor to add {{attributeType.title}} attributes
            {{/if}}
          </div>
          {{! Editor level (2) and above in Assessing can add attributes }}
          {{#if (has-module-role this.currentUser "assessing" 2)}}
            <button type="button" class="avitar-btn avitar-btn--primary avitar-btn--sm" {{on "click" (fn this.openNewAttributeModal attributeType.key)}}>
              <i class="fas fa-plus avitar-mr-1"></i>
              Add First {{attributeType.title}}
            </button>
          {{/if}}
        </div>
        {{/if}}
        {{/let}}
      </div>
      {{/each}}
    </div>
  </div>
  {{!-- Waterfront Guidelines --}}
  <div class="avitar-card">
    <div class="avitar-card__header avitar-card__header--colored">
      <h3 class="avitar-card__title">Waterfront Valuation Guidelines</h3>
      <div class="avitar-card__subtitle">Understanding waterfront property valuation</div>
    </div>
    <div class="avitar-card__body">
      <div class="avitar-grid avitar-grid-cols-1 md:avitar-grid-cols-2 avitar-gap-6">
        <div>
          <h4 class="avitar-font-semibold avitar-mb-3">Water Body Ladders</h4>
          <ul class="avitar-list avitar-text-sm avitar-space-y-2">
            <li>Each water body has a <strong>base waterfront value</strong> (e.g., Bay = $2.5M)</li>
            <li>Frontage factors from the ladder are multiplied by this base value</li>
            <li>Waterfront attributes (access, location, topography) further adjust the final value</li>
            <li>Values are interpolated between ladder entries for precise calculations</li>
            <li>Consider water quality, access, and recreational value when setting rates</li>
          </ul>
        </div>
        <div>
          <h4 class="avitar-font-semibold avitar-mb-3">Waterfront Attributes</h4>
          <ul class="avitar-list avitar-text-sm avitar-space-y-2">
            <li><strong>Water Access:</strong> Quality and ease of access to the water</li>
            <li><strong>Water Location:</strong> Positioning relative to the water body</li>
            <li><strong>Topography:</strong> Land features affecting waterfront value</li>
            <li>Attribute factors work together to determine total waterfront premium</li>
          </ul>
        </div>
      </div>
      <div class="avitar-alert avitar-alert--info avitar-mt-4">
        <div class="avitar-alert__icon">
          <i class="fas fa-info-circle"></i>
        </div>
        <div class="avitar-alert__content">
          <div class="avitar-alert__title">Valuation Example</div>
          <div class="avitar-alert__message">
            For a Bay property with 150 ft frontage: <strong>Base Value ($2.5M) × Frontage Factor (1.2)</strong> = $3,000,000 base waterfront value. This is then adjusted by waterfront attributes (access, location, topography) to determine the final property waterfront premium.
          </div>
        </div>
      </div>
    </div>
  </div>
  {{!-- Modals --}}
  <Assessing::WaterBodyEditModal @isOpen={{this.isWaterBodyModalOpen}} @waterBody={{this.editingWaterBody}} @onClose={{this.closeWaterBodyModal}} @onSave={{this.saveWaterBody}} />
  <Assessing::WaterBodyLadderEditModal @isOpen={{this.isWaterBodyLadderModalOpen}} @waterBodyLadder={{this.editingWaterBodyLadder}} @waterBodyName={{this.editingLadderWaterBody.name}} @waterBody={{this.editingLadderWaterBody}} @municipalityId={{this.model.municipality.id}} @onClose={{this.closeWaterBodyLadderModal}} @onSave={{this.saveWaterBodyLadder}} />
  <Assessing::LadderEntryEditModal @isOpen={{this.isLadderEntryModalOpen}} @ladderEntry={{this.editingLadderEntry}} @waterBodyName={{this.editingEntryWaterBody.name}} @onClose={{this.closeLadderEntryModal}} @onSave={{this.saveLadderEntry}} />
  <Assessing::WaterfrontAttributeEditModal @isOpen={{this.isWaterfrontAttributeModalOpen}} @attribute={{this.editingWaterfrontAttribute}} @attributeType={{this.editingAttributeType}} @attributeTypeName={{this.editingAttributeTypeName}} @attributeTypeIcon={{this.editingAttributeTypeIcon}} @onClose={{this.closeWaterfrontAttributeModal}} @onSave={{this.saveWaterfrontAttributeModal}} />
</div>
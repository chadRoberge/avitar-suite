{{page-title "Find Properties - Building Permits"}}

<div class="building-permits-find">

  {{#if this.selectedProperty}}
    {{!-- Property Permits/Projects List View --}}
    <div class="building-permits-find__permits-list">

      {{!-- Back Button --}}
      <div class="building-permits-find__back-button">
        <button
          type="button"
          class="avitar-btn avitar-btn--secondary"
          {{on "click" this.backToProperties}}
        >
          <i class="fas fa-arrow-left"></i>
          Back to Properties
        </button>
      </div>

      {{!-- Property Header --}}
      <div class="building-permits-find__property-header">
        <h3 class="building-permits-find__property-name">
          {{this.getDisplayName this.selectedProperty}}
        </h3>
        <p class="building-permits-find__property-info">
          PID: {{this.selectedProperty.pid}}
        </p>
      </div>

      {{!-- Loading State --}}
      {{#if this.isLoadingPermits}}
        <div class="building-permits-find__loading">
          <i class="fas fa-spinner fa-spin"></i>
          Loading permits and projects...
        </div>
      {{else}}
        {{!-- Permits/Projects List --}}
        {{#if this.displayedPermitsAndProjects.length}}
          <div class="building-permits-find__items">
            {{#each this.displayedPermitsAndProjects as |item|}}
              <div
                class="building-permits-find__item"
                {{on "click" (fn this.viewPermit item)}}
              >
                <div class="building-permits-find__item-header">
                  <span class="building-permits-find__item-type avitar-badge avitar-badge--{{if (eq item.type 'permit') 'primary' 'secondary'}}">
                    {{if (eq item.type "permit") "Permit" "Project"}}
                  </span>
                  {{#if item.status}}
                    <span class="building-permits-find__item-status avitar-badge avitar-badge--{{if (eq item.status 'approved') 'success' 'warning'}}">
                      {{item.status}}
                    </span>
                  {{/if}}
                </div>
                <div class="building-permits-find__item-info">
                  <p class="building-permits-find__item-description">
                    {{item.description}}
                  </p>
                  <p class="building-permits-find__item-date">
                    Created: {{date-format (or item.created_at item.createdAt) "MM/DD/YYYY"}}
                  </p>
                </div>
                <i class="fas fa-chevron-right building-permits-find__item-arrow"></i>
              </div>
            {{/each}}
          </div>
        {{else}}
          <div class="building-permits-find__empty">
            <i class="fas fa-folder-open"></i>
            <p>No permits or projects found for this property.</p>
          </div>
        {{/if}}
      {{/if}}
    </div>

  {{else}}
    {{!-- Property Tree Search View --}}
    <div class="building-permits-find__search">

      {{!-- Search Controls --}}
      <div class="building-permits-find__controls">
        <div class="building-permits-find__search-input">
          <i class="fas fa-search"></i>
          <input
            type="text"
            placeholder="Search by PID, address, or owner..."
            value={{this.searchQuery}}
            {{on "input" this.updateSearchQuery}}
            class="avitar-input"
          />
        </div>

        <div class="building-permits-find__group-by">
          <label>Group by:</label>
          <select
            class="avitar-select"
            value={{this.groupBy}}
            {{on "change" this.updateGroupBy}}
          >
            <option value="pid">Map (PID)</option>
            <option value="street">Street</option>
            <option value="lastname">Owner Last Name</option>
          </select>
        </div>
      </div>

      {{!-- Property Tree --}}
      <div class="building-permits-find__tree">
        <Shared::PropertyTree
          @groupedProperties={{this.groupedProperties}}
          @groupBy={{this.groupBy}}
          @selectedPropertyId={{this.selectedProperty.id}}
          @onSelectProperty={{this.selectProperty}}
          @getDisplayName={{this.getDisplayName}}
          @getSecondaryInfo={{this.getSecondaryInfo}}
        />
      </div>

      {{!-- Empty State --}}
      {{#unless this.filteredProperties.length}}
        <div class="building-permits-find__empty">
          <i class="fas fa-search"></i>
          <p>No properties found matching your search.</p>
        </div>
      {{/unless}}
    </div>
  {{/if}}

</div>

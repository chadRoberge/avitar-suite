{{page-title "Find Properties - Building Permits"}}

<div class="avitar-container avitar-py-6" {{did-update this.onPropertyChanged this.selectedProperty}}>
  {{#if this.selectedProperty}}
    {{!-- Property Info Card --}}
    <div class="avitar-card avitar-mb-4">
      <div class="avitar-card__header avitar-bg-gray-50 avitar-flex avitar-justify-between avitar-items-center">
        <h2 class="avitar-card__title">
          {{{lnr-icon "home" class="avitar-mr-2"}}}
          {{this.selectedProperty.location.address}}
        </h2>
        <button
          type="button"
          class="avitar-btn avitar-btn--primary"
          {{on "click" this.applyForPermit}}
        >
          {{{lnr-icon "plus-circle" class="avitar-mr-2"}}}
          Apply for Permit
        </button>
      </div>
      <div class="avitar-card__body">
        <div class="avitar-grid avitar-grid-cols-3 avitar-gap-4">
          <div>
            <p class="avitar-text-sm avitar-text-muted avitar-mb-1">PID</p>
            <p class="avitar-font-medium">{{this.selectedProperty.pid_formatted}}</p>
          </div>
          <div>
            <p class="avitar-text-sm avitar-text-muted avitar-mb-1">Owner</p>
            <p class="avitar-font-medium">{{this.selectedProperty.owner.primary_name}}</p>
          </div>
          <div>
            <p class="avitar-text-sm avitar-text-muted avitar-mb-1">Zone</p>
            <p class="avitar-font-medium">{{this.selectedProperty.zone.code}}</p>
          </div>
        </div>
      </div>
    </div>

    {{!-- Permits and Projects Card --}}
    <div class="avitar-card">
      <div class="avitar-card__header avitar-bg-gray-50">
        <h3 class="avitar-card__title">
          <i class="fas fa-clipboard-list avitar-mr-2"></i>
          Permits & Projects
        </h3>
      </div>

      {{#if this.isLoadingPermits}}
        <div class="avitar-card__body avitar-text-center avitar-py-8">
          <i class="fas fa-spinner fa-spin fa-2x avitar-mb-3"></i>
          <p class="avitar-text-muted">Loading permits and projects...</p>
        </div>
      {{else if this.displayedPermitsAndProjects.length}}
        <div class="avitar-card__body avitar-p-0">
          <table class="avitar-table avitar-table--hover">
            <thead>
              <tr>
                <th>Type</th>
                <th>Number</th>
                <th>Description</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each this.displayedPermitsAndProjects as |item|}}
                <tr class="avitar-cursor-pointer" {{on "click" (fn this.viewPermit item)}}>
                  <td>
                    <span class="avitar-badge avitar-badge--{{if (eq item.type 'permit') 'primary' 'secondary'}}">
                      {{if (eq item.type "permit") "Permit" "Project"}}
                    </span>
                  </td>
                  <td class="avitar-font-medium">{{item.permitNumber}}</td>
                  <td>{{item.description}}</td>
                  <td>
                    {{#if item.status}}
                      <span class="avitar-badge avitar-badge--{{if (eq item.status 'approved') 'success' 'warning'}}">
                        {{item.status}}
                      </span>
                    {{/if}}
                  </td>
                  <td class="avitar-text-sm avitar-text-muted">
                    {{date-format (or item.created_at item.createdAt) "MM/DD/YYYY"}}
                  </td>
                  <td>
                    <button
                      type="button"
                      class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--primary"
                      {{on "click" (fn this.viewPermit item)}}
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      {{else}}
        <div class="avitar-card__body avitar-text-center avitar-py-8">
          <i class="fas fa-folder-open fa-3x avitar-text-muted avitar-mb-3"></i>
          <h4 class="avitar-font-medium avitar-mb-2">No Permits or Projects</h4>
          <p class="avitar-text-muted">This property has no permits or projects on record.</p>
        </div>
      {{/if}}
    </div>
  {{else}}
    {{!-- No Property Selected --}}
    <div class="avitar-card">
      <div class="avitar-card__body avitar-text-center avitar-py-8">
        <i class="fas fa-search fa-3x avitar-text-muted avitar-mb-3"></i>
        <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">Select a Property</h3>
        <p class="avitar-text-muted">
          Use the property tree on the left to select a property and view its permits and projects.
        </p>
      </div>
    </div>
  {{/if}}
</div>

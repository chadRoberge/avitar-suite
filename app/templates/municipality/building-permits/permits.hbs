{{page-title "Permits"}}

<div class="avitar-container avitar-py-6">
  <div class="avitar-card">
    {{! Tabs }}
    <div class="avitar-card__header avitar-border-b">
      <div class="avitar-tabs">
        <button
          type="button"
          class="avitar-tab {{if (eq this.tab 'all') 'avitar-tab--active'}}"
          {{on "click" (fn this.setTab "all")}}
        >
          {{{lnr-icon "layers" class="avitar-mr-2"}}}
          All Permits
          <span class="avitar-badge avitar-badge--sm avitar-ml-2">{{this.allPermitsCount}}</span>
        </button>
        <button
          type="button"
          class="avitar-tab {{if (eq this.tab 'my') 'avitar-tab--active'}}"
          {{on "click" (fn this.setTab "my")}}
        >
          {{{lnr-icon "user" class="avitar-mr-2"}}}
          My Permits
          <span class="avitar-badge avitar-badge--sm avitar-ml-2">{{this.myPermitsCount}}</span>
        </button>
        {{#if this.canSeeReviewTab}}
          <button
            type="button"
            class="avitar-tab {{if (eq this.tab 'review') 'avitar-tab--active'}}"
            {{on "click" (fn this.setTab "review")}}
          >
            {{{lnr-icon "checkmark-circle" class="avitar-mr-2"}}}
            Requires Review
            {{#if this.requiresReviewCount}}
              <span class="avitar-badge avitar-badge--danger avitar-badge--sm avitar-ml-2">{{this.requiresReviewCount}}</span>
            {{else}}
              <span class="avitar-badge avitar-badge--sm avitar-ml-2">0</span>
            {{/if}}
          </button>
        {{/if}}
      </div>
    </div>

    {{! Filters }}
    <div class="avitar-card__header avitar-bg-gray-50">
      <div class="avitar-flex avitar-items-end avitar-gap-3">
        {{! Filter Row }}
        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-xs">Year</label>
          <select class="avitar-select avitar-select--sm" value={{this.year}} {{on "change" this.setYear}}>
            {{#each this.yearOptions as |yearOption|}}
              <option value={{yearOption.value}} selected={{eq this.year yearOption.value}}>
                {{yearOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-xs">Permit Type</label>
          <select class="avitar-select avitar-select--sm" value={{this.permitTypeId}} {{on "change" this.setPermitType}}>
            {{#each this.permitTypeOptions as |typeOption|}}
              <option value={{typeOption.value}} selected={{eq this.permitTypeId typeOption.value}}>
                {{typeOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-xs">Status</label>
          <select class="avitar-select avitar-select--sm" value={{this.status}} {{on "change" this.setStatus}}>
            {{#each this.statusOptions as |statusOption|}}
              <option value={{statusOption.value}} selected={{eq this.status statusOption.value}}>
                {{statusOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-xs">Search</label>
          <div class="avitar-flex avitar-gap-2">
            <input
              type="text"
              class="avitar-input avitar-input--sm"
              placeholder="Permit #, Address, Applicant..."
              value={{this.search}}
              {{on "input" this.updateSearch}}
              {{on "keypress" (fn (mut this.performSearch))}}
            />
            {{#if this.search}}
              <button
                type="button"
                class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                {{on "click" this.clearSearch}}
              >
                {{{lnr-icon "cross"}}}
              </button>
            {{/if}}
          </div>
        </div>

        {{! Stats }}
        <div class="avitar-text-sm avitar-text-muted avitar-whitespace-nowrap">
          {{#if (eq this.tab "review")}}
            {{#if this.userDepartment}}
              Showing {{this.displayedPermits.length}} permits awaiting {{this.userDepartment}} review
            {{else}}
              Showing {{this.displayedPermits.length}} permits requiring your review
            {{/if}}
          {{else if (eq this.tab "my")}}
            Showing {{this.displayedPermits.length}} of {{this.myPermitsCount}} my permits
          {{else}}
            Showing {{this.displayedPermits.length}} of {{@model.pagination.total}} permits
          {{/if}}
        </div>
      </div>
    </div>

    {{! Permits Table }}
    <div class="avitar-card__body avitar-p-0">
      {{#if this.displayedPermits.length}}
        <div class="avitar-table-container">
          <table class="avitar-table avitar-table--hover">
            <thead>
              <tr>
                <th>Permit Number</th>
                <th>Property Address</th>
                <th>Permit Type</th>
                <th>Applicant</th>
                <th>Application Date</th>
                <th>Status</th>
                <th>Assigned To</th>
                <th class="avitar-text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each this.displayedPermits as |permit|}}
                <tr {{on "click" (fn this.viewPermit permit)}} style="cursor: pointer;">
                  <td class="avitar-font-medium">
                    {{permit.permitNumber}}
                  </td>
                  <td>
                    {{#if permit.propertyId}}
                      <div>{{permit.propertyId.location.address}}</div>
                      <div class="avitar-text-xs avitar-text-muted">
                        PID: {{permit.propertyId.pid_formatted}}
                      </div>
                    {{else}}
                      <div>{{permit.propertyAddress}}</div>
                    {{/if}}
                  </td>
                  <td>
                    {{#if permit.permitTypeId}}
                      {{permit.permitTypeId.name}}
                      {{#if permit.permitTypeId.category}}
                        <div class="avitar-text-xs avitar-text-muted">
                          {{permit.permitTypeId.category}}
                        </div>
                      {{/if}}
                    {{else}}
                      <span class="avitar-text-muted">N/A</span>
                    {{/if}}
                  </td>
                  <td>
                    {{#if permit.applicantName}}
                      {{permit.applicantName}}
                    {{else if permit.submitted_by}}
                      {{permit.submitted_by.first_name}} {{permit.submitted_by.last_name}}
                    {{else}}
                      <span class="avitar-text-muted">N/A</span>
                    {{/if}}
                  </td>
                  <td>
                    {{date-format permit.applicationDate "MMM DD, YYYY"}}
                  </td>
                  <td>
                    <span class={{this.getStatusBadge permit.status}}>
                      {{this.formatStatus permit.status}}
                    </span>
                  </td>
                  <td>
                    {{#if permit.assignedInspector}}
                      <div class="avitar-text-sm">
                        {{permit.assignedInspector.first_name}} {{permit.assignedInspector.last_name}}
                      </div>
                      <div class="avitar-text-xs avitar-text-muted">Inspector</div>
                    {{else if permit.assignedReviewer}}
                      <div class="avitar-text-sm">
                        {{permit.assignedReviewer.first_name}} {{permit.assignedReviewer.last_name}}
                      </div>
                      <div class="avitar-text-xs avitar-text-muted">Reviewer</div>
                    {{else}}
                      <span class="avitar-text-muted">Unassigned</span>
                    {{/if}}
                  </td>
                  <td class="avitar-text-right" {{on "click" this.stopPropagation}}>
                    {{#if (eq this.tab "review")}}
                      <div class="avitar-flex avitar-gap-2 avitar-justify-end">
                        <button
                          type="button"
                          class="avitar-btn avitar-btn--sm avitar-btn--success"
                          {{on "click" (fn this.reviewPermit permit)}}
                        >
                          {{{lnr-icon "checkmark-circle" class="avitar-mr-2"}}}
                          Review
                        </button>
                        <button
                          type="button"
                          class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                          {{on "click" (fn this.viewPermit permit)}}
                        >
                          {{{lnr-icon "eye"}}}
                        </button>
                      </div>
                    {{else}}
                      <button
                        type="button"
                        class="avitar-btn avitar-btn--sm avitar-btn--primary"
                        {{on "click" (fn this.viewPermit permit)}}
                      >
                        {{{lnr-icon "eye" class="avitar-mr-2"}}}
                        View
                      </button>
                    {{/if}}
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>

        {{! Pagination }}
        {{#if (gt @model.pagination.totalPages 1)}}
          <div class="avitar-card__footer avitar-flex avitar-items-center avitar-justify-between">
            <div class="avitar-text-sm avitar-text-muted">
              Page {{@model.pagination.page}} of {{@model.pagination.totalPages}}
            </div>
            <div class="avitar-flex avitar-gap-2">
              <button
                type="button"
                class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                {{on "click" this.previousPage}}
                disabled={{eq @model.pagination.page 1}}
              >
                {{{lnr-icon "chevron-left"}}}
              </button>
              <button
                type="button"
                class="avitar-btn avitar-btn--sm avitar-btn--secondary"
                {{on "click" this.nextPage}}
                disabled={{eq @model.pagination.page @model.pagination.totalPages}}
              >
                {{{lnr-icon "chevron-right"}}}
              </button>
            </div>
          </div>
        {{/if}}
      {{else}}
        <div class="avitar-empty-state avitar-py-8">
          {{#if this.isLoadingReviewPermits}}
            {{{lnr-icon "sync" class="avitar-text-3xl avitar-text-muted avitar-mb-4 avitar-spin"}}}
            <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">Loading...</h3>
            <p class="avitar-text-muted avitar-mb-4">Fetching permits requiring your review</p>
          {{else}}
            {{{lnr-icon "file-empty" class="avitar-text-3xl avitar-text-muted avitar-mb-4"}}}
            <h3 class="avitar-text-lg avitar-font-semibold avitar-mb-2">
              {{#if (eq this.tab "review")}}
                No Permits Require Review
              {{else if (eq this.tab "my")}}
                No Permits Yet
              {{else}}
                No Permits Found
              {{/if}}
            </h3>
            <p class="avitar-text-muted avitar-mb-4">
              {{#if (eq this.tab "review")}}
                {{#if this.userDepartment}}
                  There are no permits awaiting {{this.userDepartment}} review.
                {{else}}
                  There are no permits requiring your department's review at this time.
                {{/if}}
              {{else if (eq this.tab "my")}}
                {{#if this.search}}
                  No permits you've pulled match your search criteria.
                {{else}}
                  You haven't pulled any permits in this municipality yet.
                {{/if}}
              {{else}}
                {{#if this.search}}
                  No permits match your search criteria.
                {{else}}
                  No permits found for the selected filters.
                {{/if}}
              {{/if}}
            </p>
            {{#if this.search}}
              <button
                type="button"
                class="avitar-btn avitar-btn--secondary"
                {{on "click" this.clearSearch}}
              >
                {{{lnr-icon "cross" class="avitar-mr-2"}}}
                Clear Search
              </button>
            {{else if (eq this.tab "my")}}
              <LinkTo @route="municipality.building-permits.find" class="avitar-btn avitar-btn--primary">
                {{{lnr-icon "plus-circle" class="avitar-mr-2"}}}
                Start a New Permit
              </LinkTo>
            {{/if}}
          {{/if}}
        </div>
      {{/if}}
    </div>
  </div>
</div>

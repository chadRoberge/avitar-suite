{{page-title "Building Permits Dashboard"}}

<div class="avitar-container avitar-py-6 avitar-m-4">
  {{! Header }}
  <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-6">
    <div>
      <h1 class="avitar-text-3xl avitar-font-bold avitar-mb-2">
        {{{lnr-icon "chart-bars" class="avitar-mr-2"}}}
        Building Permits Dashboard
      </h1>
      <p class="avitar-text-muted">
        Overview of building permits activity and statistics for {{this.municipality.currentMunicipality.name}}
      </p>
    </div>
    <button
      type="button"
      class="avitar-btn avitar-btn--secondary"
      {{on "click" this.refreshDashboard}}
      title="Refresh Dashboard"
    >
      {{{lnr-icon "sync" class="avitar-mr-2"}}}
      Refresh
    </button>
  </div>

  {{! Year Overview Stats }}
  <div class="avitar-mb-6">
    <h2 class="avitar-text-lg avitar-font-semibold avitar-mb-3">
      {{{lnr-icon "calendar-full" class="avitar-mr-2"}}}
      Current Year ({{this.stats.currentYear}})
    </h2>
    <div class="avitar-flex avitar-row avitar-gap-4">
      {{! Total Permits This Year }}
      <div class="avitar-flex-1 avitar-card avitar-card--stat avitar-card--hover" {{on "click" this.goToAllPermits}}>
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsThisYear 0}}</div>
              <div class="avitar-stat__label">Total Permits</div>
              {{#if this.stats.permitsVsLastYear}}
                <div class="avitar-stat__change {{if (gt this.stats.permitsVsLastYear 0) 'avitar-text-success' 'avitar-text-danger'}}">
                  {{{lnr-icon (if (gt this.stats.permitsVsLastYear 0) "arrow-up" "arrow-down") class="avitar-mr-1"}}}
                  {{this.stats.permitsVsLastYear}}% vs last year
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Revenue This Year }}
      <div class="avitar-flex-1 avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{format-currency (or this.stats.revenueThisYear 0)}}</div>
              <div class="avitar-stat__label">Revenue Generated</div>
              {{#if this.stats.revenueVsLastYear}}
                <div class="avitar-stat__change {{if (gt this.stats.revenueVsLastYear 0) 'avitar-text-success' 'avitar-text-danger'}}">
                  {{{lnr-icon (if (gt this.stats.revenueVsLastYear 0) "arrow-up" "arrow-down") class="avitar-mr-1"}}}
                  {{this.stats.revenueVsLastYear}}% vs last year
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Completed Permits }}
      <div class="avitar-flex-1 avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsCompleted 0}}</div>
              <div class="avitar-stat__label">Completed</div>
              {{#if this.stats.permitsThisYear}}
                <div class="avitar-text-sm avitar-text-muted">
                  {{number-format (multiply (divide this.stats.permitsCompleted this.stats.permitsThisYear) 100) decimals=0}}% completion rate
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Average Processing Time }}
      <div class="avitar-flex-1 avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.avgProcessingDays 0}}</div>
              <div class="avitar-stat__label">Avg. Processing Days</div>
              {{#if this.stats.avgProcessingVsLastYear}}
                <div class="avitar-stat__change {{if (lt this.stats.avgProcessingDays this.stats.avgProcessingDaysLastYear) 'avitar-text-success' 'avitar-text-danger'}}">
                  {{{lnr-icon (if (lt this.stats.avgProcessingDays this.stats.avgProcessingDaysLastYear) "arrow-down" "arrow-up") class="avitar-mr-1"}}}
                  {{this.stats.avgProcessingVsLastYear}}% vs last year
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{! Current Status Overview }}
  <div class="avitar-mb-6">
    <h2 class="avitar-text-lg avitar-font-semibold avitar-mb-3">
      {{{lnr-icon "layers" class="avitar-mr-2"}}}
      Current Status
    </h2>
    <div class="avitar-flex avitar-row avitar-gap-4">
      {{! Open Permits }}
      <div class="avitar-flex-1">
        <div class="avitar-card avitar-card--stat avitar-card--hover" {{on "click" this.goToAllPermits}}>
          <div class="avitar-card__body">
            <div class="avitar-stat avitar-text-center">
              <div class="avitar-stat__content">
                <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsOpen 0}}</div>
                <div class="avitar-stat__label">Open Permits</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{! Under Review }}
      <div class="avitar-flex-1">
        <div class="avitar-card avitar-card--stat avitar-card--hover" {{on "click" this.goToAllPermits}}>
          <div class="avitar-card__body">
            <div class="avitar-stat avitar-text-center">
              <div class="avitar-stat__content">
                <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsUnderReview 0}}</div>
                <div class="avitar-stat__label">Under Review</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{! Approved }}
      <div class="avitar-flex-1">
        <div class="avitar-card avitar-card--stat">
          <div class="avitar-card__body">
            <div class="avitar-stat avitar-text-center">
              <div class="avitar-stat__content">
                <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsApproved 0}}</div>
                <div class="avitar-stat__label">Approved</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{! In Inspections }}
      <div class="avitar-flex-1">
        <div class="avitar-card avitar-card--stat avitar-card--hover" {{on "click" this.goToInspections}}>
          <div class="avitar-card__body">
            <div class="avitar-stat avitar-text-center">
              <div class="avitar-stat__content">
                <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsInInspections 0}}</div>
                <div class="avitar-stat__label">In Inspections</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{! On Hold }}
      <div class="avitar-flex-1">
        <div class="avitar-card avitar-card--stat">
          <div class="avitar-card__body">
            <div class="avitar-stat avitar-text-center">
              <div class="avitar-stat__content">
                <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.permitsOnHold 0}}</div>
                <div class="avitar-stat__label">On Hold</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{! Permit Types Breakdown }}
  <div class="avitar-mb-6">
    <h2 class="avitar-text-lg avitar-font-semibold avitar-mb-3">
      {{{lnr-icon "apartment" class="avitar-mr-2"}}}
      Permit Types (This Year)
    </h2>
    <div class="avitar-grid avitar-grid-cols-4 avitar-gap-4">
      {{! Residential New Construction }}
      <div class="avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.newHomePermits 0}}</div>
              <div class="avitar-stat__label">New Home Construction</div>
              {{#if this.stats.newHomeRevenue}}
                <div class="avitar-text-sm avitar-text-success">
                  ${{{this.stats.newHomeRevenue}}} revenue
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Commercial }}
      <div class="avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.commercialPermits 0}}</div>
              <div class="avitar-stat__label">Commercial</div>
              {{#if this.stats.commercialRevenue}}
                <div class="avitar-text-sm avitar-text-success">
                  ${{{this.stats.commercialRevenue}}} revenue
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Renovations }}
      <div class="avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.renovationPermits 0}}</div>
              <div class="avitar-stat__label">Renovations</div>
              {{#if this.stats.renovationRevenue}}
                <div class="avitar-text-sm avitar-text-success">
                  ${{{this.stats.renovationRevenue}}} revenue
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>

      {{! Other Permits }}
      <div class="avitar-card avitar-card--stat">
        <div class="avitar-card__body">
          <div class="avitar-stat avitar-text-center">
            <div class="avitar-stat__content">
              <div class="avitar-stat__value avitar-text-4xl avitar-font-bold avitar-text-muted">{{or this.stats.otherPermits 0}}</div>
              <div class="avitar-stat__label">Other Permits</div>
              {{#if this.stats.otherRevenue}}
                <div class="avitar-text-sm avitar-text-success">
                  ${{{this.stats.otherRevenue}}} revenue
                </div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{! My Assignments (if any) }}
  {{#if this.myPermits.length}}
    <div class="avitar-mb-6">
      <div class="avitar-flex avitar-justify-between avitar-items-center avitar-mb-3">
        <h2 class="avitar-text-lg avitar-font-semibold">
          {{{lnr-icon "user" class="avitar-mr-2"}}}
          My Current Assignments
        </h2>
        <button
          type="button"
          class="avitar-btn avitar-btn--sm avitar-btn--secondary"
          {{on "click" this.goToMyAssignments}}
        >
          View All
          {{{lnr-icon "arrow-right" class="avitar-ml-2"}}}
        </button>
      </div>
      <div class="avitar-card">
        <div class="avitar-card__body avitar-p-0">
          <div class="avitar-space-y-0">
            {{#each this.myPermits as |permit|}}
              <div class="avitar-flex avitar-items-center avitar-gap-4 avitar-p-4 avitar-border-b avitar-border-gray-200 hover:avitar-bg-gray-50 avitar-cursor-pointer" {{on "click" (fn this.viewPermit permit)}}>
                <div class="avitar-flex-1">
                  <div class="avitar-font-semibold avitar-mb-1">
                    Permit #{{permit.permitNumber}}
                  </div>
                  <div class="avitar-text-sm avitar-text-muted">
                    {{permit.propertyAddress}}
                  </div>
                </div>
                <div class="avitar-text-sm">
                  <span class="{{permit.statusBadge.class}}">
                    {{permit.statusBadge.text}}
                  </span>
                </div>
              </div>
            {{/each}}
          </div>
        </div>
      </div>
    </div>
  {{/if}}

  {{! Quick Actions }}
  <div>
    <h2 class="avitar-text-lg avitar-font-semibold avitar-mb-3">
      {{{lnr-icon "pointer-right" class="avitar-mr-2"}}}
      Quick Actions
    </h2>
    <div class="avitar-flex avitar-row avitar-gap-4">
      <button
        type="button"
        class="avitar-flex-1 avitar-card avitar-card--hover avitar-text-left"
        {{on "click" this.goToAllPermits}}
      >
        <div class="avitar-card__body">
          <div class="avitar-flex avitar-items-center avitar-gap-3">
            <div class="avitar-icon-wrapper avitar-bg-primary-light avitar-text-primary">
              {{{lnr-icon "file-empty"}}}
            </div>
            <div>
              <div class="avitar-font-semibold">View All Permits</div>
              <div class="avitar-text-sm avitar-text-muted">Browse and manage all permits</div>
            </div>
          </div>
        </div>
      </button>

      <button
        type="button"
        class="avitar-flex-1 avitar-card avitar-card--hover avitar-text-left"
        {{on "click" this.goToInspections}}
      >
        <div class="avitar-card__body">
          <div class="avitar-flex avitar-items-center avitar-gap-3">
            <div class="avitar-icon-wrapper avitar-bg-info-light avitar-text-info">
              {{{lnr-icon "clipboard"}}}
            </div>
            <div>
              <div class="avitar-font-semibold">Inspections</div>
              <div class="avitar-text-sm avitar-text-muted">View scheduled inspections</div>
            </div>
          </div>
        </div>
      </button>

      <button
        type="button"
        class="avitar-flex-1 avitar-card avitar-card--hover avitar-text-left"
        {{on "click" (fn this.router.transitionTo "municipality.building-permits.reports")}}
      >
        <div class="avitar-card__body">
          <div class="avitar-flex avitar-items-center avitar-gap-3">
            <div class="avitar-icon-wrapper avitar-bg-success-light avitar-text-success">
              {{{lnr-icon "chart-bars"}}}
            </div>
            <div>
              <div class="avitar-font-semibold">Reports</div>
              <div class="avitar-text-sm avitar-text-muted">Generate permit reports</div>
            </div>
          </div>
        </div>
      </button>
    </div>
  </div>
</div>

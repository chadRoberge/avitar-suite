{{page-title "Building Permits"}}

<div class="avitar-container avitar-py-6">
  {{! Tabs }}
  <div class="avitar-card avitar-card--sticky-header avitar-mb-4">
    <div class="avitar-card__header avitar-bg-gray-50 avitar-p-0">
      <div class="avitar-tabs">
      <button
        type="button"
        class="avitar-tab {{if (eq this.selectedTab 'all') 'avitar-tab--active'}}"
        {{on "click" (fn this.selectTab "all")}}
      >
        All Applications
        {{#if this.tabStats.all}}
          <span class="avitar-badge avitar-badge--sm avitar-badge--secondary avitar-ml-2">
            {{this.tabStats.all}}
          </span>
        {{/if}}
      </button>

      <button
        type="button"
        class="avitar-tab {{if (eq this.selectedTab 'myPermits') 'avitar-tab--active'}}"
        {{on "click" (fn this.selectTab "myPermits")}}
      >
        My Assignments
        {{#if this.tabStats.myPermits}}
          <span class="avitar-badge avitar-badge--sm avitar-badge--primary avitar-ml-2">
            {{this.tabStats.myPermits}}
          </span>
        {{/if}}
      </button>

      <button
        type="button"
        class="avitar-tab {{if (eq this.selectedTab 'needingAttention') 'avitar-tab--active'}}"
        {{on "click" (fn this.selectTab "needingAttention")}}
      >
        Needs Action
        {{#if this.tabStats.needingAttention}}
          <span class="avitar-badge avitar-badge--sm avitar-badge--warning avitar-ml-2">
            {{this.tabStats.needingAttention}}
          </span>
        {{/if}}
      </button>

      <button
        type="button"
        class="avitar-tab {{if (eq this.selectedTab 'expiringSoon') 'avitar-tab--active'}}"
        {{on "click" (fn this.selectTab "expiringSoon")}}
      >
        Expiring Soon
        {{#if this.tabStats.expiringSoon}}
          <span class="avitar-badge avitar-badge--sm avitar-badge--danger avitar-ml-2">
            {{this.tabStats.expiringSoon}}
          </span>
        {{/if}}
      </button>
      </div>
    </div>
  </div>

  {{! Main Card }}
  <div class="avitar-card">
    {{! Filters }}
    <div class="avitar-card__header avitar-bg-gray-50">
      <div class="avitar-flex avitar-gap-3 avitar-items-end">
        {{! Search Input }}
        <div class="avitar-flex-1">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            <i class="fas fa-search avitar-mr-1"></i>
            Search Applications
          </label>
          <input
            type="text"
            class="avitar-input"
            placeholder="Search by permit #, applicant name, or address..."
            value={{this.searchText}}
            {{on "input" this.updateSearch}}
          />
        </div>

        {{! Status Filter }}
        <div style="min-width: 180px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Status
          </label>
          <select
            class="avitar-select"
            {{on "change" this.setFilterStatus}}
          >
            {{#each this.statusOptions as |statusOption|}}
              <option value={{statusOption.value}} selected={{eq this.filterStatus statusOption.value}}>
                {{statusOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        {{! Type Filter }}
        <div style="min-width: 180px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Permit Type
          </label>
          <select
            class="avitar-select"
            {{on "change" this.setFilterType}}
          >
            {{#each this.typeOptions as |typeOption|}}
              <option value={{typeOption.value}} selected={{eq this.filterType typeOption.value}}>
                {{typeOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        {{! Sort By }}
        <div style="min-width: 160px;">
          <label class="avitar-label avitar-text-sm avitar-font-medium avitar-mb-1">
            Sort By
          </label>
          <select
            class="avitar-select"
            {{on "change" this.setSortBy}}
          >
            {{#each this.sortOptions as |sortOption|}}
              <option value={{sortOption.value}} selected={{eq this.sortBy sortOption.value}}>
                {{sortOption.label}}
              </option>
            {{/each}}
          </select>
        </div>

        {{! Clear Filters Button }}
        {{#if this.hasFiltersApplied}}
          <div>
            <button
              type="button"
              class="avitar-btn avitar-btn--ghost avitar-btn--secondary"
              {{on "click" this.clearFilters}}
              title="Clear all filters"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
        {{/if}}
      </div>

      {{! Active Filters Display }}
      {{#if this.hasFiltersApplied}}
        <div class="avitar-flex avitar-gap-2 avitar-mt-3">
          <span class="avitar-text-sm avitar-text-muted">Active filters:</span>
          {{#if (ne this.filterStatus 'all')}}
            <span class="avitar-badge avitar-badge--secondary">
              Status: {{this.filterStatus}}
              <button
                type="button"
                class="avitar-ml-1"
                {{on "click" (fn this.setFilterStatus (hash target (hash value "all")))}}
              >
                <i class="fas fa-times"></i>
              </button>
            </span>
          {{/if}}
          {{#if (ne this.filterType 'all')}}
            <span class="avitar-badge avitar-badge--secondary">
              Type: {{this.filterType}}
              <button
                type="button"
                class="avitar-ml-1"
                {{on "click" (fn this.setFilterType (hash target (hash value "all")))}}
              >
                <i class="fas fa-times"></i>
              </button>
            </span>
          {{/if}}
          {{#if this.searchText}}
            <span class="avitar-badge avitar-badge--secondary">
              Search: "{{this.searchText}}"
              <button
                type="button"
                class="avitar-ml-1"
                {{on "click" (fn this.updateSearch (hash target (hash value "")))}}
              >
                <i class="fas fa-times"></i>
              </button>
            </span>
          {{/if}}
        </div>
      {{/if}}
    </div>
    </div>

    {{! Table Body }}
    <div class="avitar-card__body avitar-p-0">
    {{! Results Summary }}
    <div class="avitar-flex avitar-justify-between avitar-items-center avitar-p-4 avitar-pb-3 avitar-border-b">
      <div class="avitar-text-sm avitar-text-muted">
        <i class="fas fa-list-ul avitar-mr-1"></i>
        Showing <strong>{{this.displayedPermits.length}}</strong>
        {{#if (eq this.displayedPermits.length 1)}}
          application
        {{else}}
          applications
        {{/if}}
      </div>
    </div>

    {{! Permits List }}
    {{#if this.displayedPermits.length}}
      <div class="avitar-table-container">
        <table class="avitar-table avitar-table--hover avitar-table--striped" style="table-layout: fixed;">
          <thead>
            <tr>
              <th style="width: 110px;">Priority</th>
              <th style="width: 100px;">Permit #</th>
              <th style="width: 110px;">Type</th>
              <th style="width: auto;">Property</th>
              <th style="width: auto;">Applicant</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 90px;">Applied</th>
              <th style="width: 110px;">Assigned To</th>
              <th style="width: 120px;" class="avitar-text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {{#each this.displayedPermits as |permit|}}
              <tr class="avitar-cursor-pointer" {{on "click" (fn this.viewPermit permit)}}>
                <td {{on "click" this.stopPropagation}}>
                  <select
                    class="avitar-select avitar-select--sm"
                    value={{permit.priorityLevel}}
                    {{on "change" (fn this.updatePriority permit)}}
                  >
                    <option value="0">Normal</option>
                    <option value="1">Low</option>
                    <option value="2">Medium</option>
                    <option value="3">High</option>
                    <option value="4">Urgent</option>
                    <option value="5">Critical</option>
                  </select>
                </td>

                <td>
                  <div class="avitar-font-medium avitar-text-primary">
                    {{permit.permitNumber}}
                  </div>
                </td>

                <td>
                  <div class="avitar-flex avitar-items-center avitar-gap-2">
                    <i class="fas fa-{{permit.typeIcon}} avitar-text-muted"></i>
                    <span class="avitar-text-sm">{{permit.typeDisplay}}</span>
                  </div>
                </td>

                <td>
                  <div class="avitar-text-sm">
                    <div class="avitar-font-medium avitar-text-gray-900 avitar-truncate">
                      {{permit.pidFormatted}}
                    </div>
                    <div class="avitar-text-muted avitar-truncate">
                      {{permit.propertyAddress}}
                    </div>
                  </div>
                </td>

                <td>
                  <div class="avitar-text-sm">
                    <div class="avitar-font-medium avitar-truncate">{{permit.applicant.name}}</div>
                    {{#if permit.applicant.email}}
                      <div class="avitar-text-muted avitar-truncate">
                        {{permit.applicant.email}}
                      </div>
                    {{/if}}
                  </div>
                </td>

                <td>
                  <span class="{{permit.statusBadge.class}}">
                    {{permit.statusBadge.text}}
                  </span>
                </td>

                <td>
                  <div class="avitar-text-sm avitar-text-muted">
                    {{date-format permit.applicationDate "MMM DD, YYYY"}}
                  </div>
                </td>

                <td>
                  {{#if permit.assignedInspector}}
                    <div class="avitar-flex avitar-items-center avitar-gap-2">
                      <div class="avitar-avatar avitar-avatar--sm avitar-bg-primary-light avitar-text-primary">
                        {{substring permit.assignedInspector.first_name 0 1}}{{substring permit.assignedInspector.last_name 0 1}}
                      </div>
                      <div class="avitar-text-sm">
                        {{permit.assignedInspector.first_name}}
                        {{permit.assignedInspector.last_name}}
                      </div>
                    </div>
                  {{else}}
                    <span class="avitar-text-sm avitar-text-muted avitar-italic">Unassigned</span>
                  {{/if}}
                </td>

                <td {{on "click" this.stopPropagation}}>
                  <div class="avitar-flex avitar-justify-center avitar-gap-1">
                    {{#if (this.canReviewPermit permit)}}
                      <button
                        type="button"
                        class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--primary"
                        {{on "click" (fn this.reviewPermit permit)}}
                        title="Review Permit"
                      >
                        {{{lnr-icon "clipboard"}}}
                      </button>
                    {{/if}}

                    <button
                      type="button"
                      class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary"
                      {{on "click" (fn this.viewPermit permit)}}
                      title="View Details"
                    >
                      {{{lnr-icon "eye"}}}
                    </button>

                    <button
                      type="button"
                      class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary"
                      {{on "click" (fn this.editPermit permit)}}
                      title="Edit Permit"
                    >
                      {{{lnr-icon "pencil"}}}
                    </button>

                    <button
                      type="button"
                      class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--secondary"
                      {{on "click" (fn this.printPermit permit)}}
                      title="Print Permit"
                    >
                      {{{lnr-icon "printer"}}}
                    </button>

                    {{#unless permit.assignedInspector}}
                      <button
                        type="button"
                        class="avitar-btn avitar-btn--sm avitar-btn--ghost avitar-btn--primary"
                        {{on "click" (fn this.assignToMe permit)}}
                        title="Assign to Me"
                      >
                        {{{lnr-icon "user"}}}
                      </button>
                    {{/unless}}
                  </div>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    {{else}}
      <div class="avitar-empty-state avitar-py-6">
        <div class="avitar-flex avitar-flex-col avitar-items-center avitar-justify-center">
          {{#if this.hasFiltersApplied}}
            <div class="avitar-mb-4 avitar-text-center">
              <i class="fas fa-filter fa-3x avitar-text-muted"></i>
            </div>
            <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">No Applications Match Your Filters</h3>
            <p class="avitar-text-muted avitar-mb-4 avitar-text-center" style="max-width: 400px;">
              We couldn't find any permit applications matching your current search criteria. Try adjusting your filters to see more results.
            </p>
            <button
              type="button"
              class="avitar-btn avitar-btn--primary"
              {{on "click" this.clearFilters}}
            >
              <i class="fas fa-times-circle avitar-mr-2"></i>
              Clear All Filters
            </button>
          {{else}}
            <div class="avitar-mb-4 avitar-text-center">
              <div class="avitar-flex avitar-items-center avitar-justify-center avitar-mb-3">
                <div class="avitar-stat__icon avitar-stat__icon--lg avitar-bg-primary-light avitar-text-primary">
                  <i class="fas fa-clipboard-list"></i>
                </div>
              </div>
            </div>
            <h3 class="avitar-text-xl avitar-font-semibold avitar-mb-2">No Applications Yet</h3>
            <p class="avitar-text-muted avitar-mb-4 avitar-text-center" style="max-width: 450px;">
              Get started by creating your first permit application. Our streamlined process makes it easy to submit and track building permits.
            </p>
            <button
              type="button"
              class="avitar-btn avitar-btn--primary avitar-btn--lg"
              {{on "click" this.createNewPermit}}
            >
              <i class="fas fa-plus-circle avitar-mr-2"></i>
              Create First Application
            </button>
          {{/if}}
        </div>
      </div>
    {{/if}}
  </div>
</div>

{{! Print Permit Modal }}
{{#if this.showPrintModal}}
  <div class="avitar-modal-overlay avitar-modal-overlay--visible" {{on "click" this.closePrintModal}}>
    <div class="avitar-modal avitar-modal--xl" {{on "click" this.stopPropagation}} role="dialog" aria-modal="true">
      <div class="avitar-modal__header">
        <h2 class="avitar-modal__title">
          <i class="fas fa-print avitar-mr-2"></i>
          Print Permit
        </h2>
        <button type="button" class="avitar-modal__close" {{on "click" this.closePrintModal}} aria-label="Close">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="avitar-modal__body" style="max-height: 80vh; overflow-y: auto;">
        <BuildingPermits::PermitPrintView
          @permit={{this.selectedPermit}}
          @municipality={{this.municipality.currentMunicipality}}
          @inspections={{this.selectedPermit.inspections}}
        />
      </div>

      <div class="avitar-modal__footer">
        <button type="button" class="avitar-btn avitar-btn--secondary" {{on "click" this.closePrintModal}}>
          Cancel
        </button>
        <button type="button" class="avitar-btn avitar-btn--primary" {{on "click" this.triggerPrint}}>
          <i class="fas fa-print avitar-mr-2"></i>
          Print
        </button>
      </div>
    </div>
  </div>
{{/if}}
